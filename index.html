<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IES CARPE DIEM - Biblioteca Hipatia ü¶â</title>
    <link rel="icon" href="https://site.educa.madrid.org/ies.carpediem.fuenlabrada//wp-content/uploads/ies.carpediem.fuenlabrada/2023/03/logo-carpe-diem-cuadrado-500x500-blanco-100x100.png" sizes="32x32" />
    <link rel="icon" href="https://site.educa.madrid.org/ies.carpediem.fuenlabrada//wp-content/uploads/ies.carpediem.fuenlabrada/2023/03/logo-carpe-diem-cuadrado-500x500-blanco-300x300.png" sizes="192x192" />
    <link rel="apple-touch-icon" href="https://site.educa.madrid.org/ies.carpediem.fuenlabrada//wp-content/uploads/ies.carpediem.fuenlabrada/2023/03/logo-carpe-diem-cuadrado-500x500-blanco-300x300.png" />
    <meta name="msapplication-TileImage" content="https://site.educa.madrid.org/ies.carpediem.fuenlabrada//wp-content/uploads/ies.carpediem.fuenlabrada/2023/03/logo-carpe-diem-cuadrado-500x500-blanco-300x300.png" />
    <link rel="preload" href="./Ejemplares.xml" crossorigin="anonymous">
    <link rel="preload" href="https://raw.githubusercontent.com/IES-Carpe-Diem/Biblioteca-Hipatia/refs/heads/main/logo%20biblioteca.png" as="image">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.10/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.18/marked.min.js"></script>
    <meta name="dcterms.conformance" content="WCAG 2.2 AA">
    <style>
        :root {
            --bg-primary: #f4f4f4;
            --bg-secondary: white;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #ddd;
            --btn-primary: #1a73e8;
            --btn-hover: #1a73e8;
            --btn-reserva: #2a2a2a;
            --btn-reserva-hover: #2a2a2a;
            --btn-solicitud: #2a2a2a;
            --btn-solicitud-hover: #2a2a2a;
            --btn-donaciones: #2a2a2a;
            --btn-donaciones-hover: #2a2a2a;
            --btn-rese√±a: #2a2a2a;
            --btn-rese√±a-hover: #2a2a2a;
            --btn-favoritos: #2a2a2a;
            --btn-favoritos-hover: #2a2a2a;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
            --chat-bg: #f9f9f9;
            --user-msg-bg: #c9c9c9;
            --bot-msg-bg: #c9c9c9;
            --bot-msg-color: #000000;
            --splash-bg: linear-gradient(135deg, rgb(255, 255, 255) 0%, #c8c8c8 50%, #ffffff 100%);
            --splash-text: rgb(0, 0, 0);
            --splash-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            --btn-proseguir: #17a2b8;
            --btn-proseguir-hover: #138496;
            --btn-buscar-libro: #3399ff;
            --btn-buscar-libro-hover: #1a73e8;
            --btn-sinopsis: #28a745;
            --btn-sinopsis-hover: #218838;
            --font-size: 1em;
            --letter-spacing: 0em;
            --button-size: 1em;
            --contrast: 1;
            --brightness: 1;
        }
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #ffffff;
            --border-color: #666;
            --btn-primary: #1a73e8;
            --btn-hover: #1a73e8;
            --btn-reserva: #2a2a2a;
            --btn-reserva-hover: #2a2a2a;
            --btn-solicitud: #2a2a2a;
            --btn-solicitud-hover: #2a2a2a;
            --btn-donaciones: #2a2a2a;
            --btn-donaciones-hover: #2a2a2a;
            --btn-rese√±a: #2a2a2a;
            --btn-rese√±a-hover: #2a2a2a;
            --btn-favoritos: #2a2a2a;
            --btn-favoritos-hover: #2a2a2a;
            --shadow: 0 2px 5px rgba(0,0,0,0.3);
            --chat-bg: #374151;
            --user-msg-bg: #3a3a3a;
            --bot-msg-bg: #3a3a3a;
            --bot-msg-color: #e0e0e0;
            --splash-bg: linear-gradient(135deg, #374151 0%, #374151 50%, #374151 100%);
            --splash-text: rgb(255, 255, 255);
            --splash-shadow: 2px 2px 4px rgba(255, 255, 255, 0.2);
            --btn-proseguir: #17a2b8;
            --btn-proseguir-hover: #138496;
            --btn-buscar-libro: #1a73e8;
            --btn-buscar-libro-hover: #1a73e8;
            --btn-sinopsis: #28a745;
            --btn-sinopsis-hover: #218838;
        }
        html {
            font-size: var(--font-size);
            transition: font-size 0.3s ease, filter 0.3s;
            filter: saturate(var(--contrast)) brightness(var(--brightness));
        }
        [data-daltonism="normal"] {
            filter: none;
        }
        [data-daltonism="deuteranomaly"] {
            filter: brightness(1.1) contrast(1.2) hue-rotate(30deg);
        }
        [data-daltonism="protanomaly"] {
            filter: brightness(1.1) contrast(1.2) sepia(0.3) hue-rotate(-30deg);
        }
        [data-daltonism="tritanomaly"] {
            filter: brightness(1.15) contrast(1.3) hue-rotate(180deg) saturate(1.4);
        }
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 1.25rem;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s, font-size 0.3s, letter-spacing 0.3s;
            font-size: 1rem;
            letter-spacing: var(--letter-spacing);
        }
        button, input, select, textarea {
            font-size: var(--button-size);
            padding: calc(var(--button-size) * 0.5);
            letter-spacing: var(--letter-spacing);
        }
        .header-search button,
        .chat-controls button,
        .proseguir-btn,
        .buscar-libro-btn,
        .reserva-libro-btn,
        .solicitud-libro-btn,
        .sinopsis-btn,
        .theme-toggle,
        .accessibility-toggle {
            font-size: var(--button-size);
            padding: calc(var(--button-size) * 0.4);
            letter-spacing: var(--letter-spacing);
        }
        .accessibility-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 0.375rem;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2em;
            letter-spacing: var(--letter-spacing);
        }
        .accessibility-toggle:hover,
        .accessibility-toggle:focus {
            background: rgba(255,255,255,0.35);
            transform: scale(1.1);
            outline: 2px solid var(--text-primary);
        }
        [data-theme="dark"] .accessibility-toggle {
            background: rgba(0,0,0,0.2);
        }
        [data-theme="dark"] .accessibility-toggle:hover,
        [data-theme="dark"] .accessibility-toggle:focus {
            background: rgba(0,0,0,0.35);
            outline: 2px solid var(--text-primary);
        }
        .accessibility-toggle.active {
            background: rgba(255,255,255,0.4) !important;
            box-shadow: 0 0 0.5rem rgba(255,255,255,0.6);
        }
        [data-theme="dark"] .accessibility-toggle.active {
            background: rgba(0,0,0,0.4) !important;
            box-shadow: 0 0 0.5rem rgba(255,255,255,0.4);
        }
        #splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--splash-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
            color: var(--splash-text);
            font-family: 'Arial', sans-serif;
            text-align: center;
            overflow: hidden;
            text-shadow: var(--splash-shadow);
            filter: none;
        }
        #splash.hidden {
            opacity: 0;
            pointer-events: none;
        }
        .splash-container {
            animation: fadeInContainer 1.5s ease-out;
        }
        #splash img {
            max-width: 250px;
            height: auto;
            margin-bottom: 20px;
            border-radius: 12px;
            animation: bounceIn 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.5s both;
            transition: transform 0.3s ease;
        }
        #splash img:hover,
        #splash img:focus {
            transform: scale(1.05);
        }
        #splash h2 {
            font-size: 2.8rem;
            margin: 15px 0;
            font-weight: bold;
            animation: fadeInUp 0.8s ease-out 1s both;
            letter-spacing: 1px;
        }
        #splash p {
            font-size: 1.3rem;
            opacity: 0.95;
            margin-bottom: 20px;
            animation: fadeInUp 0.8s ease-out 1.2s both;
        }
        @keyframes fadeInContainer {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        @keyframes bounceIn {
            0% {
                opacity: 0;
                transform: scale(0.3);
            }
            50% {
                opacity: 1;
                transform: scale(1.05);
            }
            70% {
                transform: scale(0.9);
            }
            100% {
                opacity: 1;
                transform: scale(1);
            }
        }
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        #app {
            display: none;
        }
        header {
            text-align: center;
            background-image: url('https://site.educa.madrid.org/ies.carpediem.fuenlabrada//wp-content/uploads/ies.carpediem.fuenlabrada/2024/03/carpediem-foto-inicio1920x1200c.jpg');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            position: relative;
        }
        .theme-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 1100;
        }
        .theme-controls.active {
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }
        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 1.2em;
        }
        .theme-toggle:hover,
        .theme-toggle:focus {
            background: rgba(255,255,255,0.3);
            outline: 2px solid var(--text-primary);
        }
        [data-theme="dark"] .theme-toggle {
            background: rgba(0,0,0,0.2);
        }
        [data-theme="dark"] .theme-toggle:hover,
        [data-theme="dark"] .theme-toggle:focus {
            background: rgba(0,0,0,0.3);
            outline: 2px solid var(--text-primary);
        }
        .header-search {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .search-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            width: 100%;
            max-width: 600px;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            width: 100%;
        }
        .header-search input {
            padding: 8px;
            border: none;
            border-radius: 4px;
            width: 250px;
            max-width: 100%;
            background: rgba(255,255,255,0.9);
        }
        .header-search button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .header-search .buscar-btn {
            background-color: var(--btn-primary);
        }
        .header-search .buscar-btn:hover,
        .header-search .buscar-btn:focus {
            background-color: var(--btn-hover);
            outline: 2px solid var(--text-primary);
        }
        .header-search .reserva-btn {
            background-color: var(--btn-reserva);
        }
        .header-search .reserva-btn:hover,
        .header-search .reserva-btn:focus {
            background-color: var(--btn-reserva-hover);
            outline: 2px solid var(--text-primary);
        }
        .header-search .rese√±a-btn {
            background-color: var(--btn-rese√±a);
        }
        .header-search .rese√±a-btn:hover,
        .header-search .rese√±a-btn:focus {
            background-color: var(--btn-rese√±a-hover);
            outline: 2px solid var(--text-primary);
        }
        .header-search .solicitud-btn {
            background-color: var(--btn-solicitud);
        }
        .header-search .solicitud-btn:hover,
        .header-search .solicitud-btn:focus {
            background-color: var(--btn-solicitud-hover);
            outline: 2px solid var(--text-primary);
        }
        .header-search .donaciones-btn {
            background-color: var(--btn-donaciones);
        }
        .header-search .donaciones-btn:hover,
        .header-search .donaciones-btn:focus {
            background-color: var(--btn-donaciones-hover);
            outline: 2px solid var(--text-primary);
        }
        .header-search .favoritos-btn {
            background-color: var(--btn-favoritos);
            font-size: 1.2em;
        }
        .header-search .favoritos-btn:hover,
        .header-search .favoritos-btn:focus {
            background-color: var(--btn-favoritos-hover);
            outline: 2px solid var(--text-primary);
        }
        .header-search .valorados-btn {
            background-color: var(--btn-favoritos);
            font-size: 1.2em;
        }
        .header-search .valorados-btn:hover,
        .header-search .valorados-btn:focus {
            background-color: var(--btn-favoritos-hover);
            outline: 2px solid var(--text-primary);
        }
        main {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        section {
            flex: 1;
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
            min-width: 250px;
        }
        #chatSection {
            flex: 2;
            min-width: 300px;
        }
        #seccionIzquierda h3, #seccionDerecha h3 {
            text-align: center;
            margin-bottom: 15px;
            color: var(--text-primary);
        }
        .recomendados-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 10px;
            height: 400px;
            overflow-y: auto;
        }
        .recomendados-grid img {
            width: 100%;
            height: 180px;
            object-fit: cover;
            border-radius: 6px;
            cursor: pointer;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            box-shadow: var(--shadow);
        }
        .recomendados-grid img:hover,
        .recomendados-grid img:focus {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            outline: 2px solid var(--text-primary);
        }
        .rotativas-container {
            position: relative;
            height: 400px;
            overflow: hidden;
            border-radius: 8px;
        }
        .rotativas-container img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            cursor: pointer;
            transition: opacity 1s ease-in-out;
            opacity: 0;
            border-radius: 6px;
            box-shadow: var(--shadow);
        }
        .rotativas-container img.active {
            opacity: 1;
        }
        .rotativas-container img:hover,
        .rotativas-container img:focus {
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            outline: 2px solid var(--text-primary);
        }
        #chatMensajes {
            height: 200px;
            overflow-y: scroll;
            border: 1px solid var(--border-color);
            padding: 10px;
            margin: 10px 0;
            background-color: var(--chat-bg);
            color: var(--text-primary);
        }
        .mensaje {
            margin: 5px 0;
            padding: 5px;
            color: var(--text-primary);
            border-radius: 4px;
            position: relative;
        }
        .mensaje.user {
            background-color: var(--user-msg-bg);
            text-align: right;
        }
        .mensaje.bot {
            background-color: var(--bot-msg-bg);
            color: var(--bot-msg-color);
        }
        .mensaje.temporal {
            font-style: italic;
            color: #888;
            opacity: 0.7;
        }
        .mensaje.temporal.typing {
            background-color: var(--user-msg-bg);
            text-align: center;
            font-style: italic;
            color: var(--text-secondary);
            opacity: 0.8;
        }
        .typing-dots {
            display: inline-block;
        }
        .typing-dots::after {
            content: '...';
            animation: bounce 1.4s infinite ease-in-out;
        }
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
            }
            40% {
                transform: scale(1);
            }
        }
        [data-theme="dark"] .typing-dots::after {
            color: var(--text-primary);
        }
        .proseguir-btn, .buscar-libro-btn, .reserva-libro-btn, .solicitud-libro-btn, .sinopsis-btn {
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            margin-right: 5px;
            display: inline-block;
            transition: background-color 0.3s;
        }
        .proseguir-btn {
            background-color: var(--btn-proseguir);
            color: white;
        }
        .proseguir-btn:hover,
        .proseguir-btn:focus {
            background-color: var(--btn-proseguir-hover);
            outline: 2px solid var(--text-primary);
        }
        .buscar-libro-btn {
            background-color: var(--btn-buscar-libro);
            color: white;
        }
        .buscar-libro-btn:hover,
        .buscar-libro-btn:focus {
            background-color: var(--btn-buscar-libro-hover);
            outline: 2px solid var(--text-primary);
        }
        .reserva-libro-btn {
            background-color: var(--btn-reserva);
            color: white;
        }
        .reserva-libro-btn:hover,
        .reserva-libro-btn:focus {
            background-color: var(--btn-reserva-hover);
            outline: 2px solid var(--text-primary);
        }
        .solicitud-libro-btn {
            background-color: var(--btn-solicitud);
            color: white;
        }
        .solicitud-libro-btn:hover,
        .solicitud-libro-btn:focus {
            background-color: var(--btn-solicitud-hover);
            outline: 2px solid var(--text-primary);
        }
        .sinopsis-btn {
            background-color: var(--btn-sinopsis);
            color: white;
        }
        .sinopsis-btn:hover,
        .sinopsis-btn:focus {
            background-color: var(--btn-sinopsis-hover);
            outline: 2px solid var(--text-primary);
        }
        .favorito-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            margin-left: 5px;
            transition: transform 0.2s;
        }
        .favorito-btn:hover,
        .favorito-btn:focus {
            transform: scale(1.1);
            outline: 2px solid var(--text-primary);
        }
        .favorito-btn.active {
            color: #ff0000;
        }
        .chat-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .chat-controls input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .chat-controls input::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }
        .chat-controls button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: var(--btn-primary);
            color: white;
            cursor: pointer;
        }
        .chat-controls button:hover,
        .chat-controls button:focus {
            background-color: var(--btn-hover);
            outline: 2px solid var(--text-primary);
        }
        #searchModal, #adminModal, #favoritosModal, #valoradosModal, #accessibilityModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            pointer-events: none;
        }
        #searchModalContent, #adminModalContent, #favoritosModalContent, #valoradosModalContent, #accessibilityModalContent {
            background-color: var(--bg-secondary);
            margin: 5% auto;
            padding: 1.25rem;
            border: none;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 37.5rem;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            color: var(--text-primary);
            box-sizing: border-box;
            position: relative;
            pointer-events: auto;
        }
        #accessibilityModalContent {
            max-width: 37.5rem;
        }
        .modal-close {
            color: var(--text-secondary);
            float: right;
            font-size: 1.75rem;
            font-weight: bold;
            cursor: pointer;
            pointer-events: auto;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: var(--text-primary);
            outline: 2px solid var(--text-primary);
        }
        .modal-search {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .modal-search input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .modal-search button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: var(--btn-primary);
            color: white;
            cursor: pointer;
        }
        .modal-search button:hover,
        .modal-search button:focus {
            background-color: var(--btn-hover);
            outline: 2px solid var(--text-primary);
        }
        .libro-modal {
            border: 1px solid var(--border-color);
            padding: 0;
            margin: 10px 0;
            border-radius: 4px;
            background: var(--bg-secondary);
            overflow: hidden;
            display: flex;
            gap: 15px;
        }
        .portada-section {
            flex: 0 0 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .info-section {
            flex: 1;
            padding: 15px;
            line-height: 1.6;
        }
        .info-section p {
            margin: 8px 0;
        }
        .tejuelo {
            font-family: monospace;
            padding: 2px 4px;
            border-radius: 2px;
            color: black;
        }
        .tejuelo[data-categoria="narrativa"] {
            background-color: #1bd47a;
        }
        .tejuelo[data-categoria="poes√≠a"] {
            background-color: #ff48a9;
        }
        .tejuelo[data-categoria="teatro"] {
            background-color: #e350de;
        }
        .tejuelo[data-categoria="literatura inglesa"] {
            background-color: #d4d700;
        }
        .tejuelo[data-categoria="enciclopedias"] {
            background-color: #ffaa00;
        }
        .tejuelo[data-categoria="c√≥mic"] {
            background-color: #33c5ff;
        }
        .tejuelo[data-categoria="deportes"] {
            background-color: #ff0000;
        }
        .tejuelo[data-categoria="lecturas graduadas"] {
            background-color: #000080;
            color: #000000;
        }
        .tejuelo:not([data-categoria]),
        .tejuelo[data-categoria="no disponible"] {
            background-color: #cccccc;
        }
        .pagination {
            text-align: center;
            margin: 10px 0;
        }
        .pagination button {
            background-color: var(--btn-primary);
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        .pagination button:hover,
        .pagination button:focus {
            outline: 2px solid var(--text-primary);
        }
        .pagination button:disabled {
            background-color: var(--border-color);
            color: #ffffff;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .pagination button.active {
            background-color: var(--text-secondary);
            font-weight: bold;
        }
        .pagination span {
            font-weight: bold;
        }
        #conteoResultadosModal {
            font-weight: bold;
            color: var(--btn-primary);
            margin-bottom: 10px;
            padding: 5px;
            background-color: #e9f5ff;
            border-radius: 4px;
        }
        .toast {
            position: fixed;
            bottom: 1.25rem;
            right: 1.25rem;
            background: #28a745;
            color: white;
            padding: 0.9375rem;
            border-radius: 0.25rem;
            box-shadow: var(--shadow);
            z-index: 10000;
            min-width: 18.75rem;
            animation: slideInRight 0.3s ease-out;
            role: alert;
        }
        .toast.error {
            background: #dc3545;
        }
        .toast.warning {
            background: #ffc107;
            color: black;
        }
        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
            white-space: nowrap;
        }
        .skip-link {
            position: absolute;
            top: -40px;
            left: 6px;
            background: var(--btn-primary);
            color: white;
            padding: 8px;
            text-decoration: none;
            z-index: 100;
        }
        .skip-link:focus {
            top: 6px;
        }
        .admin-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .admin-form input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        .admin-form button {
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .admin-login-btn {
            background-color: var(--btn-primary);
            color: white;
        }
        .admin-cancel-btn {
            background-color: #666;
            color: white;
        }
        #contadorDia {
            text-align: center;
            font-size: 0.9em;
            color: var(--text-secondary);
            margin: 5px 0 15px 0;
        }
        .estrellas {
            cursor: pointer;
            font-size: 1.2em;
            user-select: none;
            position: relative;
            overflow: visible;
            display: inline-block;
            z-index: 10;
        }
        .estrella {
            position: relative;
            display: inline-block;
            width: 1.2em;
            height: 1.2em;
            font-size: 1.2em;
            color: #ddd;
            cursor: pointer;
            transition: color 0.2s ease, transform 0.1s ease;
            text-align: center;
            line-height: 1.2em;
            user-select: none;
        }
        .estrella::after {
            content: attr(data-value);
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.65em;
            font-weight: bold;
            color: #333;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s ease, color 0.2s ease;
        }
        .estrella:hover::after,
        .estrella.hover::after {
            opacity: 1;
            color: #000 !important;
        }
        .estrella:hover,
        .estrella.seleccionada {
            color: #ffd700 !important;
        }
        .estrella.hover {
            color: #ffd700 !important;
        }
        .estrella:hover {
            transform: scale(1.2);
        }
        .estrella.seleccionada {
            color: #ffd700 !important;
        }
        .estrella.pendiente-eliminar {
            color: #dc3545 !important;
            animation: pulse 0.1s ease-in-out;
        }
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.2);
            }
        }
        .promedio {
            margin-left: 8px;
            font-size: 0.9em;
            color: #555;
            font-weight: bold;
        }
        .accessibility-form {
            display: flex;
            flex-direction: column;
            gap: 0.9375rem;
        }
        .accessibility-group {
            display: flex;
            flex-direction: column;
            gap: 0.3125rem;
        }
        .accessibility-group label {
            font-weight: bold;
            color: var(--text-primary);
        }
        .accessibility-group input[type="range"] {
            width: 100%;
            margin: 0.3125rem 0;
        }
        .accessibility-group input[type="checkbox"] {
            margin-right: 0.3125rem;
        }
        .accessibility-group input[type="checkbox"]:checked {
            background-color: #28a745 !important;
            border-color: #28a745 !important;
            accent-color: #28a745;
        }
        .daltonism-options {
            display: flex;
            flex-direction: column;
            gap: 0.625rem;
        }
        .daltonism-option {
            display: flex;
            align-items: center;
            gap: 0.625rem;
        }
        .daltonism-option input[type="radio"] {
            margin: 0;
        }
        .accessibility-group button {
            padding: 0.5rem;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            letter-spacing: var(--letter-spacing);
        }
        .accessibility-group .reset-btn {
            background-color: #6c757d;
            color: white;
        }
        .accessibility-section {
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .accessibility-section h4 {
            margin-top: 0;
            color: var(--btn-primary);
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        @media (max-width: 768px) {
            main {
                flex-direction: column;
            }
            #chatSection {
                flex: none;
                order: 3;
            }
            #seccionIzquierda, #seccionDerecha {
                order: 1;
                flex: 1;
            }
            #splash h2 {
                font-size: 2rem;
            }
            #splash p {
                font-size: 1.1rem;
            }
            #splash img {
                max-width: 180px;
            }
            .search-container, .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            .header-search input,
            .header-search button {
                width: 100%;
                max-width: 300px;
            }
            #searchModalContent, #adminModalContent, #favoritosModalContent, #valoradosModalContent, #accessibilityModalContent {
                width: 95%;
                margin: 10% auto;
                padding: 0.9375rem;
            }
            .toast {
                bottom: 10px;
                right: 10px;
                left: 10px;
                min-width: auto;
            }
            .theme-controls {
                flex-direction: column;
                gap: 2px;
            }
            .chat-controls {
                flex-direction: column;
            }
            .libro-modal {
                flex-direction: column;
                text-align: center;
            }
            .portada-section {
                flex: none;
                margin-bottom: 10px;
            }
            .recomendados-grid, .rotativas-container {
                height: 300px;
            }
        }
        @media (prefers-reduced-motion: reduce) {
            #splash img, #splash h2, #splash p {
                animation: none !important;
                transition: none !important;
            }
            .rotativas-container img {
                transition: none;
            }
        }
        .portada-container {
            position: relative;
            width: 120px;
            height: 180px;
            background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
            border-radius: 6px;
            overflow: hidden;
            background-size: 200% 200%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
        }
        @keyframes skeleton-loading {
            0% {
                background-position: 0% 50%;
            }
            50% {
                background-position: 100% 50%;
            }
            100% {
                background-position: 0% 50%;
            }
        }
        .portada-container.loaded {
            animation: none;
            background: none;
        }
        .portada-container img.default-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
            z-index: 3;
        }
        .portada-slider-3d {
            width: 120px;
            height: 180px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s ease;
            z-index: 3;
        }
        .portada-img-3d {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            backface-visibility: hidden;
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            opacity: 0.9;
            z-index: 4;
        }
        .portada-img-3d.active {
            opacity: 1;
            transform: translateZ(60px);
            z-index: 10;
        }
        @media (prefers-reduced-motion: reduce) {
            .portada-container::after {
                animation: none;
            }
            .rotativas-container img {
                transition: none;
            }
        }
        @media (prefers-reduced-motion: reduce) {
            .portada-container::before {
            }
        }
        .fireworks {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1001;
        }
        .firework-particle {
            position: absolute;
            width: 4px;
            height: 4px;
            background: #ffd700;
            border-radius: 50%;
            pointer-events: none;
            animation: firework-burst 1s ease-out forwards;
        }
        @keyframes firework-burst {
            0% {
                opacity: 1;
                transform: scale(0) translate(0, 0);
            }
            100% {
                opacity: 0;
                transform: scale(1) translate(var(--dx), var(--dy));
            }
        }
        .explosion {
            animation: explosion-shake 0.5s ease-in-out;
        }
        @keyframes explosion-shake {
            0%, 100% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-5px);
            }
            75% {
                transform: translateX(5px);
            }
        }
        .estrellas {
            cursor: pointer;
            font-size: 1.2em;
            user-select: none;
            position: relative;
            overflow: visible;
            display: inline-block;
            z-index: 10;
        }
        .firework-particle {
            position: absolute;
            width: 6px;
            height: 6px;
            background: #ffd700;
            border-radius: 50%;
            pointer-events: none;
            animation: firework-burst 1s ease-out forwards;
            box-shadow: 0 0 4px rgba(255, 215, 0, 0.8);
        }
        .firework-particle:nth-child(even) {
            background: #ff69b4;
        }
        @keyframes explosion-shake {
            0%, 100% {
                transform: translateX(0) rotate(0deg);
            }
            25% {
                transform: translateX(-8px) rotate(-2deg);
            }
            75% {
                transform: translateX(8px) rotate(2deg);
            }
        }
        .explosion .estrella {
            animation: pulse 0.2s ease-in-out;
        }
        .fireworks.fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            z-index: 9999 !important;
        }
        .conformance-note {
            text-align: center;
            font-size: 0.8em;
            color: var(--text-secondary);
            margin-top: 20px;
            padding: 10px;
            border-top: 1px solid var(--border-color);
        }
        .conformance-note a {
            color: var(--btn-primary);
            text-decoration: underline;
        }
        .conformance-note img {
            width: 20px;
            height: auto;
            vertical-align: middle;
            margin-right: 5px;
        }
    </style>
</head>
<body data-theme="light" data-daltonism="normal">
    <a href="#main-content" class="skip-link" aria-label="Ir al contenido principal">Saltar al contenido principal</a>
    <div id="splash" tabindex="0">
        <div class="splash-container">
            <img src="https://raw.githubusercontent.com/IES-Carpe-Diem/Biblioteca-Hipatia/refs/heads/main/logo%20biblioteca.png"
                alt="Logo de la Biblioteca Hipatia"
                loading="lazy"
                onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2NjIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWxlPSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkxvZ28gTm8gQ2FycmVnYWRvPC90ZXh0Pjwvc3ZnPg=='">
            <h2>¬°Bienvenidos a la Biblioteca Hipatia!</h2>
            <p>Cargando el cat√°logo de libros y aventuras...</p>
        </div>
    </div>
    <div id="app">
        <header role="banner">
            <div class="theme-controls">
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Cambiar entre tema claro y oscuro" title="Cambiar tema (claro/oscuro)">üåô</button>
                <button class="accessibility-toggle" onclick="abrirModalAccesibilidad()" aria-label="Abrir ajustes de accesibilidad" title="Ajustes de accesibilidad">‚ôø</button>
                <button class="logout-btn" onclick="logoutAdmin()" aria-label="Cerrar sesi√≥n de administrador" style="display: none;">Cerrar Sesi√≥n üîí</button>
            </div>
            <h1>ü¶â Biblioteca Hipatia - <a href="https://site.educa.madrid.org/ies.carpediem.fuenlabrada/" target="_blank" rel="noopener noreferrer" style="color:#ffffff;"> IES CARPE DIEM</a></h1>
            <div class="header-search" role="search">
                <div class="search-container">
                    <input type="search" id="buscarInput" placeholder="Busca por t√≠tulo, autor, tejuelo, categor√≠a"
                        aria-label="Buscar libros por t√≠tulo, autor, tejuelo o categor√≠a"
                        aria-describedby="search-instruction"
                        autocomplete="off"
                        onkeypress="handleSearchKeypress(event)"
                        list="sugerenciasBusqueda">
                    <datalist id="sugerenciasBusqueda"></datalist>
                    <button class="buscar-btn" onclick="mostrarResultadosBusqueda()" aria-label="Buscar libros en el cat√°logo">Buscar üîç</button>
                </div>
                <div class="action-buttons">
                    <button class="reserva-btn" onclick="openReservationForm()"
                            aria-label="Abrir formulario de reserva de libros">Reserva de Libros üìö</button>
                    <button class="rese√±a-btn" onclick="openReviewForm()"
                            aria-label="Abrir formulario de rese√±as de libros">Rese√±a de Libros ‚úçÔ∏è</button>
                    <button class="solicitud-btn" onclick="openRequestForm()"
                            aria-label="Abrir formulario de solicitud de libros nuevos">Solicitud de Libros üó≥Ô∏è</button>
                    <button class="donaciones-btn" onclick="openDonationForm()"
                            aria-label="Abrir formulario de donaciones de libros">Donaci√≥n de Libros üì¶</button>
                    <button class="favoritos-btn" onclick="abrirModalFavoritos()" aria-label="Ver libros favoritos">‚ù§Ô∏è</button>
                    <button class="valorados-btn" onclick="abrirModalValorados()" aria-label="Ver libros m√°s valorados">‚≠ê</button>
                </div>
            </div>
            <p id="search-instruction" class="visually-hidden">Busca libros por t√≠tulo, autor, tejuelo o categor√≠a en la barra de b√∫squeda.</p>
        </header>
        <main id="main-content" role="main" tabindex="-1">
            <section id="seccionIzquierda" role="region" aria-labelledby="tituloRecomendados">
                <h3 id="tituloRecomendados">La bibliotecaria est√° buscando los libros de hoy, dale unos minutos</h3>
                <p id="contadorDia"></p>
                <div id="recomendadosGrid" class="recomendados-grid"></div>
            </section>
            <section id="chatSection" role="region" aria-labelledby="chatTitle">
                <h2 id="chatTitle">Hipat-IA</h2>
                <p>¬°Tu Bibliotecaria Virtual! üë©‚Äçüíº</p>
                <div id="chatMensajes" role="log" aria-live="polite"></div>
                <div class="chat-controls">
                    <input type="text" id="chatInput" placeholder="Libros, sinopsis, recomendaciones..."
                        aria-label="Enviar mensaje a la bibliotecaria virtual"
                        aria-describedby="chat-instruction"
                        autocomplete="off"
                        onkeypress="handleChatKeypress(event)">
                    <button onclick="enviarMensaje()" aria-label="Enviar mensaje al chatbot">Enviar üí¨</button>
                </div>
                <p id="chat-instruction" class="visually-hidden">Env√≠a un mensaje a la bibliotecaria virtual para obtener ayuda con libros o recomendaciones.</p>
            </section>
            <section id="seccionDerecha" role="region" aria-labelledby="rotativasTitle">
                <h3 id="rotativasTitle">Portadas rotativas</h3>
                <div id="rotativasContainer" class="rotativas-container"></div>
            </section>
        </main>
        <footer class="conformance-note">
            <p><img src="https://site.educa.madrid.org/ies.carpediem.fuenlabrada//wp-content/uploads/ies.carpediem.fuenlabrada/2023/03/logo-carpe-diem-cuadrado-500x500-blanco-100x100.png" alt="Logo IES Carpe Diem"> IES CARPE DIEM ¬© 2025</p>
        </footer>
        <div id="searchModal" tabindex="0">
            <div id="searchModalContent" role="dialog" aria-modal="true" aria-labelledby="searchModalTitle">
                <span class="modal-close" role="button" aria-label="Cerrar ventana de resultados de b√∫squeda" onclick="cerrarModal()">√ó</span>
                <h3 id="searchModalTitle">Resultados de B√∫squeda</h3>
                <div class="modal-search">
                    <input type="search" id="modalSearchInput" placeholder="Busca por t√≠tulo, autor, tejuelo, categor√≠a"
                        aria-label="Buscar libros en el modal por t√≠tulo, autor, tejuelo o categor√≠a"
                        autocomplete="off"
                        onkeypress="handleModalSearchKeypress(event)">
                    <button onclick="buscarEnModal()" aria-label="Buscar libros en el cat√°logo">Buscar üîç</button>
                </div>
                <div id="conteoResultadosModal"></div>
                <div id="resultadosModal"></div>
                <div id="searchPagination" class="pagination"></div>
            </div>
        </div>
        <div id="adminModal">
            <div id="adminModalContent" role="dialog" aria-modal="true" aria-labelledby="adminModalTitle">
                <span class="modal-close" onclick="cerrarModalAdmin()">√ó</span>
                <h3 id="adminModalTitle">Panel de Administrador</h3>
                <div id="adminContent"></div>
            </div>
        </div>
        <div id="favoritosModal">
            <div id="favoritosModalContent" role="dialog" aria-modal="true" aria-labelledby="favoritosModalTitle">
                <span class="modal-close" onclick="cerrarModalFavoritos()">√ó</span>
                <h3 id="favoritosModalTitle">Tus favsüíñ</h3>
                <div id="favoritosContent"></div>
                <div id="favoritosPagination" class="pagination" style="display: none;"></div>
            </div>
        </div>
        <div id="valoradosModal">
            <div id="valoradosModalContent" role="dialog" aria-modal="true" aria-labelledby="valoradosModalTitle">
                <span class="modal-close" onclick="cerrarModalValorados()">√ó</span>
                <h3 id="valoradosModalTitle">Top 10üöÄ</h3>
                <div id="valoradosContent"></div>
                <div id="valoradosPagination" class="pagination" style="display: none;"></div>
            </div>
        </div>
        <div id="accessibilityModal" tabindex="0">
            <div id="accessibilityModalContent" role="dialog" aria-modal="true" aria-labelledby="accessibilityModalTitle">
                <span class="modal-close" role="button" aria-label="Cerrar ventana de accesibilidad" onclick="cerrarModalAccesibilidad()">√ó</span>
                <h3 id="accessibilityModalTitle">Ajustes de Accesibilidad</h3>
                <div id="accessibilityContent" class="accessibility-form">
                    <!-- Contenido din√°mico cargado por JS -->
                </div>
            </div>
        </div>
    </div>
    <script>
        // Configuraciones globales
        const CONFIG = {
            CACHE_DURATION: 24 * 60 * 60 * 1000,
            PAGE_SIZE: 5,
            RETRY_MAX: 3,
            DEBOUNCE_DELAY: 300,
            ADMIN_USER: "admin",
            ADMIN_PASS: "hipatia2025",
            API_KEY: 'AIzaSyCls5FtXaTdzQfM5FarqmHSALeGmnIPcAg',
            BASE_URL: 'https://generativelanguage.googleapis.com/v1beta/models/',
            MODELOS_A_PROBAR: [
                'gemini-2.5-flash',
                'gemini-2.5-pro',
                'gemini-2.0-flash',
                'gemini-1.5-flash-latest',
                'gemini-1.5-pro-latest'
            ],
            GITHUB_API_URL: 'https://api.github.com/repos/IES-Carpe-Diem/Biblioteca-Hipatia/contents/portadas/',
            DEFAULT_PORTADA: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIiBzdHJva2U9IiNhYWEiIHN0cm9rZS13aWR0aD0iMiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5Qb3J0YWRhIG5vIGRpc3BvbmlibGU8L3RleHQ+PC9zdmc+',
            WEB_APP_URL: 'https://script.google.com/macros/s/AKfycby283Cbhy1uOkPmnnmxztRCVGhqGsbqJFfqwkuawvupViPlJ-fXOQM0RbRgm7n-m0kYEg/exec',
            FORMS: {
                RESERVA: 'https://docs.google.com/forms/d/e/1FAIpQLSeTUAdMIEZz0lP2qflcZgfIP2zhsU4sYJoQZYoJcmvUZRAQnw/viewform?usp=header',
                RESE√ëA: 'https://docs.google.com/forms/d/e/1FAIpQLScbwLhvODSn6s5oP_GOdVhtUtojdiDUOBe5O2pJexUW5VT-Fw/viewform?usp=header',
                SOLICITUD: 'https://docs.google.com/forms/d/e/1FAIpQLSf_VH-Wmf7SC7geWNwoLhX1aqc_xy1LQ-fp-SFYdlOYIbTE-g/viewform?usp=header',
                DONACIONES: 'https://forms.gle/GobAksYs7vpXY8HG6'
            }
        };
        let catalogo = [];
        let searchResults = [];
        let searchQuery = '';
        let currentPageSearch = 1;
        let currentPageFavoritos = 1;
        let currentPageValorados = 1;
        let toastCount = 0;
        let respuestasPendientes = {};
        let mensajeActualId = 0;
        let historialMensajes = [];
        let cacheRespuestas = JSON.parse(localStorage.getItem('hipatia_cache')) || {};
        let favoritos = JSON.parse(localStorage.getItem('libros_favoritos')) || [];
        let librosConPortadas = [];
        let rotativasInterval = null;
        let currentRotativaIndex = 0;
        let MODELO_FUNCIONAL = localStorage.getItem('gemini_modelo_funcional') || null;
        function debounce(func, delay) {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(null, args), delay);
            };
        }

        function sanitizeHTML(str) {
            return DOMPurify.sanitize(str);
        }

        function showToast(message, type = 'success') {
            const toastContainer = document.createElement('div');
            toastContainer.className = `toast ${type}`;
            toastContainer.style.position = 'fixed';
            toastContainer.style.bottom = `${20 + (toastCount * 60)}px`;
            toastContainer.style.right = '20px';
            toastContainer.style.padding = '15px';
            toastContainer.style.borderRadius = '4px';
            toastContainer.style.boxShadow = 'var(--shadow)';
            toastContainer.style.zIndex = 10000 + toastCount;
            toastContainer.style.minWidth = '300px';
            toastContainer.style.animation = 'slideInRight 0.3s ease-out';
            toastContainer.setAttribute('role', 'alert');
            toastContainer.setAttribute('aria-live', 'polite');
            toastContainer.textContent = message;
            document.body.appendChild(toastContainer);
            toastCount++;
            setTimeout(() => {
                toastContainer.remove();
                toastCount--;
            }, 5000);
        }
        function setupFocusTrap(modalId, focusableSelector = 'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])') {
            const modal = document.getElementById(modalId);
            const modalContent = modal.querySelector('#' + modalId.replace('Modal', 'ModalContent'));
            const firstFocusable = modalContent.querySelector(focusableSelector);
            const focusableElements = modalContent.querySelectorAll(focusableSelector);
            const lastFocusable = focusableElements[focusableElements.length - 1];
            if (!firstFocusable) return;
            firstFocusable.focus();
            const handleKeydown = (e) => {
                if (e.key === 'Tab') {
                    if (e.shiftKey && document.activeElement === firstFocusable) {
                        e.preventDefault();
                        lastFocusable.focus();
                    } else if (!e.shiftKey && document.activeElement === lastFocusable) {
                        e.preventDefault();
                        firstFocusable.focus();
                    }
                }
            };
            modal.addEventListener('keydown', handleKeydown);
            const cleanup = () => {
                modal.removeEventListener('keydown', handleKeydown);
            };
            modal._focusTrapCleanup = cleanup;
            return { firstFocusable, lastFocusable };
        }
        function cleanupFocusTrap(modalId) {
            const modal = document.getElementById(modalId);
            if (modal && modal._focusTrapCleanup) {
                modal._focusTrapCleanup();
                delete modal._focusTrapCleanup;
            }
        }
        function toggleTheme() {
            const body = document.body;
            const isDark = body.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const themeBtn = document.querySelector('.theme-toggle');
            themeBtn.textContent = newTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
            showToast(newTheme === 'dark' ? 'Modo oscuro activado' : 'Modo claro activado', 'success');
        }
        function loadTheme() {
            const saved = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const defaultTheme = saved || (prefersDark ? 'dark' : 'light');
            document.body.setAttribute('data-theme', defaultTheme);
            const themeBtn = document.querySelector('.theme-toggle');
            themeBtn.textContent = defaultTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';
        }
        function setDaltonismMode(mode) {
            const body = document.body;
            body.setAttribute('data-daltonism', mode);
            localStorage.setItem('daltonism-mode', mode);
            const labels = {
                normal: 'Modo normal',
                deuteranomaly: 'Deuteranomal√≠a (verde-rojo)',
                protanomaly: 'Protanomal√≠a (rojo-verde)',
                tritanomaly: 'Tritanomal√≠a (azul-amarillo)'
            };
            showToast(`Daltonismo: ${labels[mode]}`, 'success');
            document.querySelectorAll('input[name="daltonism"]').forEach(radio => {
                radio.checked = radio.value === mode;
            });
        }
        function loadDaltonismMode() {
            const saved = localStorage.getItem('daltonism-mode') || 'normal';
            document.body.setAttribute('data-daltonism', saved);
        }
        function updateFontSize(value) {
            const numValue = parseFloat(value) || 50;
            const multiplier = 0.2 + (numValue / 100) * 1.6;
            document.documentElement.style.setProperty('--font-size', `${multiplier}em`);
            localStorage.setItem('font-size', numValue);
            const fontValueSpan = document.getElementById('font-size-value');
            if (fontValueSpan) {
                fontValueSpan.textContent = numValue + '%';
            }
        }
        function updateLetterSpacing(value) {
            const numValue = parseFloat(value) || 50;
            const spacing = (numValue - 50) / 50 * 0.32;
            document.documentElement.style.setProperty('--letter-spacing', `${spacing}em`);
            localStorage.setItem('letter-spacing', numValue);
            const letterValueSpan = document.getElementById('letter-spacing-value');
            if (letterValueSpan) {
                letterValueSpan.textContent = numValue + '%';
            }
        }
        function updateButtonSize(value) {
            const numValue = parseFloat(value) || 50;
            const multiplier = 0.2 + (numValue / 100) * 1.6;
            document.documentElement.style.setProperty('--button-size', `${multiplier}em`);
            localStorage.setItem('button-size', numValue);
            const buttonValueSpan = document.getElementById('button-size-value');
            if (buttonValueSpan) {
                buttonValueSpan.textContent = numValue + '%';
            }
        }
        function updateContrast(value) {
            const numValue = parseFloat(value) || 50;
            const level = 0.2 + (numValue / 100) * 1.6;
            document.documentElement.style.setProperty('--contrast', level);
            localStorage.setItem('contrast', numValue);
            const contrastValueSpan = document.getElementById('contrast-value');
            if (contrastValueSpan) {
                contrastValueSpan.textContent = numValue + '%';
            }
        }
        function updateBrightness(value) {
            const numValue = parseFloat(value) || 50;
            const level = 0.3 + (numValue / 100) * 1.4;
            document.documentElement.style.setProperty('--brightness', level);
            localStorage.setItem('brightness', numValue);
            const brightnessValueSpan = document.getElementById('brightness-value');
            if (brightnessValueSpan) {
                brightnessValueSpan.textContent = numValue + '%';
            }
        }
        function loadSizeCSS() {
            try {
                const fontSize = localStorage.getItem('font-size') || 50;
                const letterSpacing = localStorage.getItem('letter-spacing') || 50;
                const buttonSize = localStorage.getItem('button-size') || 50;
                const contrast = localStorage.getItem('contrast') || 50;
                const brightness = localStorage.getItem('brightness') || 50;
                updateFontSize(fontSize);
                updateLetterSpacing(letterSpacing);
                updateButtonSize(buttonSize);
                updateContrast(contrast);
                updateBrightness(brightness);
            } catch (e) {
                console.warn('Error loading accessibility CSS:', e);
                document.documentElement.style.setProperty('--font-size', '1em');
                document.documentElement.style.setProperty('--letter-spacing', '0em');
                document.documentElement.style.setProperty('--button-size', '1em');
                document.documentElement.style.setProperty('--contrast', '1');
                document.documentElement.style.setProperty('--brightness', '1');
            }
        }
        function loadSliderValues() {
            const fontSize = localStorage.getItem('font-size') || 50;
            const letterSpacing = localStorage.getItem('letter-spacing') || 50;
            const buttonSize = localStorage.getItem('button-size') || 50;
            const contrast = localStorage.getItem('contrast') || 50;
            const brightness = localStorage.getItem('brightness') || 50;
            const fontSlider = document.getElementById('font-size-slider');
            const letterSlider = document.getElementById('letter-spacing-slider');
            const buttonSlider = document.getElementById('button-size-slider');
            const contrastSlider = document.getElementById('contrast-slider');
            const brightnessSlider = document.getElementById('brightness-slider');
            const fontValue = document.getElementById('font-size-value');
            const letterValue = document.getElementById('letter-spacing-value');
            const buttonValue = document.getElementById('button-size-value');
            const contrastValue = document.getElementById('contrast-value');
            const brightnessValue = document.getElementById('brightness-value');
            if (fontSlider) fontSlider.value = fontSize;
            if (letterSlider) letterSlider.value = letterSpacing;
            if (buttonSlider) buttonSlider.value = buttonSize;
            if (contrastSlider) contrastSlider.value = contrast;
            if (brightnessSlider) brightnessSlider.value = brightness;
            if (fontValue) fontValue.textContent = fontSize + '%';
            if (letterValue) letterValue.textContent = letterSpacing + '%';
            if (buttonValue) buttonValue.textContent = buttonSize + '%';
            if (contrastValue) contrastValue.textContent = contrast + '%';
            if (brightnessValue) brightnessValue.textContent = brightness + '%';
        }
        function resetAccessibility() {
            setDaltonismMode('normal');
            const fontSlider = document.getElementById('font-size-slider');
            const letterSlider = document.getElementById('letter-spacing-slider');
            const buttonSlider = document.getElementById('button-size-slider');
            const contrastSlider = document.getElementById('contrast-slider');
            const brightnessSlider = document.getElementById('brightness-slider');
            if (fontSlider) fontSlider.value = 50;
            if (letterSlider) letterSlider.value = 50;
            if (buttonSlider) buttonSlider.value = 50;
            if (contrastSlider) contrastSlider.value = 50;
            if (brightnessSlider) brightnessSlider.value = 50;
            updateFontSize(50);
            updateLetterSpacing(50);
            updateButtonSize(50);
            updateContrast(50);
            updateBrightness(50);
            showToast('Ajustes de accesibilidad restablecidos', 'success');
        }
        function abrirModalAccesibilidad() {
            const content = document.getElementById('accessibilityContent');
            const currentDaltonism = document.body.getAttribute('data-daltonism') || 'normal';
            content.innerHTML = `
                <div class="accessibility-section">
                    <h4>‚å®Ô∏è Navegaci√≥n por Teclado y Lectores de pantalla</h4>
                    <p>¬°Hola, explorador! Usa el Tabulador para saltar entre botones e inputs, Enter para activarlos y Escape para cerrar ventanas. Si lees con un screen reader üëÇ, como NVDA o VoiceOver, hemos etiquetado todo para que sea claro y accesible.</p>
                </div>
                <div class="accessibility-section">
                    <h4>üëÅÔ∏è Visi√≥n y Contraste</h4>
                    <div class="accessibility-group">
                        <label for="contrast-slider">Alto Contraste (<span id="contrast-value">50%</span>)</label>
                        <input type="range"
                               id="contrast-slider"
                               min="0"
                               max="100"
                               value="50"
                               step="1"
                               oninput="updateContrast(this.value)">
                    </div>
                    <div class="accessibility-group">
                        <label for="brightness-slider">Brillo (<span id="brightness-value">50%</span>)</label>
                        <input type="range"
                               id="brightness-slider"
                               min="0"
                               max="100"
                               value="50"
                               step="1"
                               oninput="updateBrightness(this.value)">
                    </div>
                    <div class="accessibility-group">
                        <label>Daltonismo</label>
                        <div class="daltonism-options">
                            <div class="daltonism-option">
                                <input type="radio"
                                       id="daltonism-normal"
                                       name="daltonism"
                                       value="normal"
                                       ${currentDaltonism === 'normal' ? 'checked' : ''}>
                                <label for="daltonism-normal">Normal</label>
                            </div>
                            <div class="daltonism-option">
                                <input type="radio"
                                       id="daltonism-deuteranomaly"
                                       name="daltonism"
                                       value="deuteranomaly"
                                       ${currentDaltonism === 'deuteranomaly' ? 'checked' : ''}>
                                <label for="daltonism-deuteranomaly">Deuteranomal√≠a (verde-rojo)</label>
                            </div>
                            <div class="daltonism-option">
                                <input type="radio"
                                       id="daltonism-protanomaly"
                                       name="daltonism"
                                       value="protanomaly"
                                       ${currentDaltonism === 'protanomaly' ? 'checked' : ''}>
                                <label for="daltonism-protanomaly">Protanomal√≠a (rojo-verde)</label>
                            </div>
                            <div class="daltonism-option">
                                <input type="radio"
                                       id="daltonism-tritanomaly"
                                       name="daltonism"
                                       value="tritanomaly"
                                       ${currentDaltonism === 'tritanomaly' ? 'checked' : ''}>
                                <label for="daltonism-tritanomaly">Tritanomal√≠a (azul-amarillo)</label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="accessibility-section">
                    <h4>‚úã Tama√±os y Espaciado</h4>
                    <div class="accessibility-group">
                        <label for="font-size-slider">Tama√±o de Letras (<span id="font-size-value">50%</span>)</label>
                        <input type="range"
                               id="font-size-slider"
                               min="0"
                               max="100"
                               value="50"
                               step="1"
                               oninput="updateFontSize(this.value)">
                    </div>
                    <div class="accessibility-group">
                        <label for="letter-spacing-slider">Espacio entre Letras (<span id="letter-spacing-value">50%</span>)</label>
                        <input type="range"
                               id="letter-spacing-slider"
                               min="0"
                               max="100"
                               value="50"
                               step="1"
                               oninput="updateLetterSpacing(this.value)">
                    </div>
                    <div class="accessibility-group">
                        <label for="button-size-slider">Tama√±o de Botones (<span id="button-size-value">50%</span>)</label>
                        <input type="range"
                               id="button-size-slider"
                               min="0"
                               max="100"
                               value="50"
                               step="1"
                               oninput="updateButtonSize(this.value)">
                    </div>
                </div>
                <div class="accessibility-section">
                    <h4>‚ÑπÔ∏è Sobre estos ajustes</h4>
                    <p>Inspirados en las <a href="https://www.w3.org/WAI/standards-guidelines/wcag/es" target="_blank" rel="noopener noreferrer">Directrices WCAG 2.2</a> del W3C, estos controles garantizan una accesibilidad web inclusiva y te permiten personalizar tu experiencia adapt√°ndola a tus necesidades espec√≠ficas.</p>
                </div>
                <div class="accessibility-group">
                    <button class="reset-btn" onclick="resetAccessibility()">Restablecer Ajustes</button>
                </div>
            `;
            loadSliderValues();
            document.querySelectorAll('input[name="daltonism"]').forEach(radio => {
                radio.addEventListener('change', (e) => setDaltonismMode(e.target.value));
            });
            document.getElementById('accessibilityModal').style.display = 'block';
            setupFocusTrap('accessibilityModal');
            const themeControls = document.querySelector('.theme-controls');
            if (themeControls) themeControls.classList.add('active');
        }
        function cerrarModalAccesibilidad() {
            cleanupFocusTrap('accessibilityModal');
            document.getElementById('accessibilityModal').style.display = 'none';
            const themeControls = document.querySelector('.theme-controls');
            if (themeControls) themeControls.classList.remove('active');
        }
        function cerrarModal() {
            cleanupFocusTrap('searchModal');
            document.getElementById('searchModal').style.display = 'none';
            document.getElementById('buscarInput').focus();
            document.getElementById('modalSearchInput').value = '';
            document.querySelector('.theme-controls').classList.remove('active');
        }
        function cerrarModalAdmin() {
            cleanupFocusTrap('adminModal');
            document.getElementById('adminModal').style.display = 'none';
            document.getElementById('adminContent').innerHTML = '';
        }
        function cerrarModalFavoritos() {
            cleanupFocusTrap('favoritosModal');
            document.getElementById('favoritosModal').style.display = 'none';
            currentPageFavoritos = 1;
        }
        function cerrarModalValorados() {
            cleanupFocusTrap('valoradosModal');
            document.getElementById('valoradosModal').style.display = 'none';
            currentPageValorados = 1;
        }
        function openReservationForm() {
            window.open(CONFIG.FORMS.RESERVA, '_blank', 'noopener,noreferrer');
        }
        function openReviewForm() {
            window.open(CONFIG.FORMS.RESE√ëA, '_blank', 'noopener,noreferrer');
        }
        function openRequestForm() {
            window.open(CONFIG.FORMS.SOLICITUD, '_blank', 'noopener,noreferrer');
        }
        function openDonationForm() {
            window.open(CONFIG.FORMS.DONACIONES, '_blank', 'noopener,noreferrer');
        }
        const handleSearchKeypress = debounce((event) => {
            if (event.key === 'Enter') mostrarResultadosBusqueda();
        }, CONFIG.DEBOUNCE_DELAY);
        const handleChatKeypress = debounce((event) => {
            if (event.key === 'Enter') enviarMensaje();
        }, CONFIG.DEBOUNCE_DELAY);
        const handleModalSearchKeypress = debounce((event) => {
            if (event.key === 'Enter') buscarEnModal();
        }, CONFIG.DEBOUNCE_DELAY);
        async function cargarCatalogo(reintentosMaximos = CONFIG.RETRY_MAX) {
            const cacheVersion = 'catalog-v1';
            const cachedCatalogo = localStorage.getItem('catalogo');
            const cachedVersion = localStorage.getItem('catalogoVersion');
            const cachedTimestamp = localStorage.getItem('catalogoTimestamp');
            if (cachedCatalogo && cachedVersion === cacheVersion && cachedTimestamp) {
                const timestamp = parseInt(cachedTimestamp, 10);
                if (Date.now() - timestamp < CONFIG.CACHE_DURATION) {
                    catalogo = JSON.parse(cachedCatalogo);
                    actualizarSugerenciasBusqueda();
                    return;
                }
            }
            let ultimoError = null;
            for (let intento = 0; intento < reintentosMaximos; intento++) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 10000);
                    const response = await fetch('./Ejemplares.xml', { signal: controller.signal });
                    clearTimeout(timeoutId);
                    if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                    const xmlText = await response.text();
                    const xmlDoc = parseXML(xmlText);
                    const libros = parseLibros(xmlDoc);
                    const librosAgrupados = agruparEjemplares(xmlDoc, libros);
                    await mergePortadas(librosAgrupados);
                    catalogo = Object.values(librosAgrupados).map(libro => ({
                        ...libro,
                        idRegistro: libro.idRegistro || libro.id_documento || ''
                    }));
                    librosConPortadas = catalogo.map(libro => ({
                        id: libro.idRegistro,
                        titulo: libro.titulo,
                        portadas: libro.portadas
                    }));
                    localStorage.setItem('catalogo', JSON.stringify(catalogo));
                    localStorage.setItem('catalogoVersion', cacheVersion);
                    localStorage.setItem('catalogoTimestamp', Date.now());
                    actualizarSugerenciasBusqueda();
                    console.log(`Cat√°logo cargado exitosamente en intento ${intento + 1}.`);
                    return;
                } catch (error) {
                    ultimoError = error;
                    console.warn(`Intento ${intento + 1}/${reintentosMaximos} fall√≥: ${error.message}`);
                    if (intento < reintentosMaximos - 1) {
                        const delay = 1000 * Math.pow(2, intento);
                        console.log(`Reintentando en ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                    }
                }
            }
            console.error('Todos los reintentos fallaron:', ultimoError);
            catalogo = [];
            showToast('Cat√°logo en Mantenimiento, disculpe las molestias.', 'error');
        }
        function parseXML(xmlText) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
            if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                throw new Error('Error al parsear XML.');
            }
            return xmlDoc;
        }
        function parseLibros(xmlDoc) {
            const libros = {};
            Array.from(xmlDoc.getElementsByTagName('Libro')).forEach(libro => {
                const idDocumento = libro.getAttribute('id_documento') || '';
                const descriptor = libro.getElementsByTagName('Descriptor')[0];
                const rawCategoria = descriptor ? descriptor.textContent : 'No disponible';
                const categoriaMap = {
                    'narrativa': 'Narrativa',
                    'poesia': 'Poes√≠a',
                    'poes√≠a': 'Poes√≠a',
                    'teatro': 'Teatro',
                    'literatura inglesa': 'Literatura inglesa',
                    'enciclopedias': 'Enciclopedias',
                    'comic': 'C√≥mic',
                    'c√≥mic': 'C√≥mic',
                    'deportes': 'Deportes',
                    'lecturas graduadas': 'Lecturas Graduadas'
                };
                const categoria = categoriaMap[rawCategoria.toLowerCase()] || rawCategoria;
                libros[idDocumento] = {
                    titulo: libro.getElementsByTagName('Titulo')[0]?.textContent || 'Sin t√≠tulo',
                    autor: libro.getElementsByTagName('Autor')[0]?.textContent || 'Desconocido',
                    categoria: categoria,
                    fechaEdicion: libro.getElementsByTagName('FechaEdicion')[0]?.textContent || 'No disponible'
                };
            });
            return libros;
        }
        function agruparEjemplares(xmlDoc, libros) {
            const librosAgrupados = {};
            Array.from(xmlDoc.getElementsByTagName('Ejemplar')).forEach(ejemplar => {
                const idRegistro = ejemplar.getAttribute('IdRegistro') || '';
                const libro = libros[idRegistro] || {};
                let signatura1 = ejemplar.getAttribute('Signatura1') || '';
                const signaturaMap = {
                    'Narrativa': 'N',
                    'Poes√≠a': 'P',
                    'Teatro': 'T',
                    'Literatura inglesa': 'LI',
                    'Enciclopedias': 'E',
                    'C√≥mic': 'C',
                    'Deportes': 'D',
                    'Lecturas Graduadas': 'AC'
                };
                signatura1 = signaturaMap[libro.categoria] || signatura1 || '';
                const signatura = `${signatura1}-${ejemplar.getAttribute('Signatura2') || ''}-${ejemplar.getAttribute('Signatura3') || ''}`.trim();
                const tituloNormalizado = normalizarTexto(libro.titulo || 'Sin t√≠tulo').replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
                if (!librosAgrupados[idRegistro]) {
                    librosAgrupados[idRegistro] = {
                        titulo: libro.titulo || 'Sin t√≠tulo',
                        autor: libro.autor || 'Desconocido',
                        categoria: libro.categoria || 'No disponible',
                        fechaEdicion: libro.fechaEdicion || 'No disponible',
                        signatura: signatura || 'No disponible',
                        isbn: ejemplar.getAttribute('ISBN') || 'No disponible',
                        fecha: ejemplar.getAttribute('Fecha') || 'No disponible',
                        copiasTotales: 0,
                        copiasDisponibles: 0,
                        idRegistro: idRegistro,
                        portadas: []
                    };
                }
                librosAgrupados[idRegistro].copiasTotales += 1;
                if (ejemplar.getAttribute('Estado') === '0') {
                    librosAgrupados[idRegistro].copiasDisponibles += 1;
                }
            });
            return librosAgrupados;
        }
        async function mergePortadas(librosAgrupados) {
            const portadasGuardadas = JSON.parse(localStorage.getItem('portadas_libros') || '{}');
            Object.keys(librosAgrupados).forEach(idRegistro => {
                const portadasPersistidas = portadasGuardadas[idRegistro] || [];
                portadasPersistidas.forEach(portada => {
                    if (!librosAgrupados[idRegistro].portadas.includes(portada)) {
                        librosAgrupados[idRegistro].portadas.push(portada);
                    }
                });
            });
        }
        async function cargarPortadasDesdeGitHub() {
            try {
                const response = await fetch(CONFIG.GITHUB_API_URL, {
                    headers: { 'Accept': 'application/vnd.github.v3+json' },
                    cache: 'default'
                });
                if (!response.ok) return;
                const files = await response.json();
                const portadasGuardadas = JSON.parse(localStorage.getItem('portadas_libros') || '{}');
                files.forEach(file => {
                    if (file.name.endsWith('.jpg') || file.name.endsWith('.jpeg') || file.name.endsWith('.png')) {
                        const match = file.name.match(/^(.+?)_\d+\.(jpg|jpeg|png)$/);
                        if (match) {
                            const idLibro = match[1];
                            const url = file.download_url;
                            const libro = catalogo.find(l => l.idRegistro === idLibro);
                            if (libro && !libro.portadas.includes(url)) {
                                libro.portadas.push(url);
                            }
                            if (!portadasGuardadas[idLibro]) portadasGuardadas[idLibro] = [];
                            if (!portadasGuardadas[idLibro].includes(url)) {
                                portadasGuardadas[idLibro].push(url);
                            }
                        }
                    }
                });
                librosConPortadas = catalogo.map(libro => ({
                    id: libro.idRegistro,
                    titulo: libro.titulo,
                    portadas: [...(libro.portadas || []), ...(portadasGuardadas[libro.idRegistro] || [])]
                })).filter(l => l.portadas.length > 0);
                localStorage.setItem('portadas_libros', JSON.stringify(portadasGuardadas));
                console.log('Portadas cargadas desde GitHub:', Object.keys(portadasGuardadas));
            } catch (error) {
                console.warn('No se pudieron cargar portadas desde GitHub:', error);
            }
        }
        function normalizarTexto(texto) {
            if (!texto) return '';
            const acentos = {
                '√°': 'a', '√©': 'e', '√≠': 'i', '√≥': 'o', '√∫': 'u',
                '√Å': 'A', '√â': 'E', '√ç': 'I', '√ì': 'O', '√ö': 'U'
            };
            return texto
                .replace(/[√°√©√≠√≥√∫√Å√â√ç√ì√ö]/g, match => acentos[match] || match)
                .toLowerCase()
                .replace(/\s+/g, ' ')
                .trim();
        }
        function buscarLibros(query, exactMatch = false) {
            if (!catalogo.length || !query) return [];
            const lowerQuery = normalizarTexto(query);
            if (exactMatch) {
                return catalogo.filter(libro => normalizarTexto(libro.titulo) === lowerQuery);
            }
            return catalogo
                .filter(libro =>
                    normalizarTexto(libro.titulo).includes(lowerQuery) ||
                    normalizarTexto(libro.autor).includes(lowerQuery) ||
                    normalizarTexto(libro.categoria).includes(lowerQuery) ||
                    normalizarTexto(libro.signatura).includes(lowerQuery) ||
                    normalizarTexto(libro.isbn).includes(lowerQuery)
                )
                .sort((a, b) => (b.copiasDisponibles || 0) - (a.copiasDisponibles || 0));
        }
        function actualizarSugerenciasBusqueda() {
            const datalist = document.getElementById('sugerenciasBusqueda');
            datalist.innerHTML = catalogo.map(libro => `
                <option value="${libro.titulo}">${libro.autor} - ${libro.categoria} (${libro.copiasDisponibles || 0} disponibles)</option>
            `).join('');
        }
        function mostrarResultadosBusqueda() {
            if (!catalogo.length) {
                showToast('Cat√°logo en Mantenimiento, disculpe las molestias.', 'warning');
                return;
            }
            const query = document.getElementById('buscarInput').value.trim();
            if (!query) {
                showToast('Por favor, introduce un t√©rmino de b√∫squeda.', 'warning');
                return;
            }
            searchQuery = query;
            searchResults = buscarLibros(query);
            currentPageSearch = 1;
            abrirModal();
            mostrarResultadosModal();
        }
        function buscarEnModal() {
            const query = document.getElementById('modalSearchInput').value.trim();
            if (!query) {
                showToast('Por favor, introduce un t√©rmino de b√∫squeda.', 'warning');
                return;
            }
            searchQuery = query;
            document.getElementById('buscarInput').value = query;
            searchResults = buscarLibros(query);
            currentPageSearch = 1;
            mostrarResultadosModal();
        }
        function abrirModal() {
            const modal = document.getElementById('searchModal');
            const modalSearchInput = document.getElementById('modalSearchInput');
            modalSearchInput.value = searchQuery;
            modal.style.display = 'block';
            setupFocusTrap('searchModal');
            modalSearchInput.focus();
            document.querySelector('.theme-controls').classList.add('active');
            detenerRotativas();
        }
        async function renderPortadas(container, idLibro) {
            const libro = catalogo.find(l => l.idRegistro === idLibro);
            if (!libro || !libro.portadas || libro.portadas.length === 0) {
                const defaultImg = document.createElement('img');
                defaultImg.src = CONFIG.DEFAULT_PORTADA;
                defaultImg.alt = 'Portada no disponible';
                defaultImg.className = 'default-placeholder';
                defaultImg.style.cssText = 'width:100%; height:100%; object-fit:cover; border-radius:6px;';
                container.appendChild(defaultImg);
                container.classList.add('loaded');
                return;
            }
            const slider = document.createElement('div');
            slider.className = 'portada-slider';
            container.appendChild(slider);
            const loadImagePromises = libro.portadas.map((url, index) =>
                new Promise((resolve) => {
                    const img = new Image();
                    img.src = url;
                    img.alt = '';
                    img.className = 'portada-img';
                    img.crossOrigin = 'anonymous';
                    img.loading = 'lazy';
                    img.onload = () => resolve({ img, index, success: true });
                    img.onerror = () => {
                        const saved = JSON.parse(localStorage.getItem('portadas_libros') || '{}');
                        if (saved[idLibro]) {
                            saved[idLibro] = saved[idLibro].filter(u => u !== url);
                            localStorage.setItem('portadas_libros', JSON.stringify(saved));
                        }
                        resolve({ index, success: false });
                    };
                    setTimeout(() => {
                        if (!img.complete) resolve({ index, success: false });
                    }, 5000);
                })
            );
            const results = await Promise.all(loadImagePromises);
            const validImages = results.filter(r => r.success && r.img).map(r => ({ img: r.img, index: r.index }));
            if (validImages.length === 0) {
                slider.remove();
                const defaultImg = document.createElement('img');
                defaultImg.src = CONFIG.DEFAULT_PORTADA;
                defaultImg.alt = 'Portada no disponible';
                defaultImg.className = 'default-placeholder';
                defaultImg.style.cssText = 'width:100%; height:100%; object-fit:cover; border-radius:6px;';
                container.appendChild(defaultImg);
                container.classList.add('loaded');
                return;
            }
            validImages.forEach((item, i) => {
                item.img.style.display = 'block';
                if (i === 0) item.img.classList.add('active');
                slider.appendChild(item.img);
            });
            if (validImages.length >= 1) {
                slider.classList.add('portada-slider-3d');
                const angle = 360 / validImages.length;
                validImages.forEach((item, i) => {
                    const img = item.img;
                    img.className = 'portada-img-3d';
                    if (i === 0) img.classList.add('active');
                    img.style.transform = `rotateY(${i * angle}deg) translateZ(80px)`;
                    slider.appendChild(img);
                });
                let current = 0;
                const interval = setInterval(() => {
                    current = (current + 1) % validImages.length;
                    slider.style.transform = `rotateY(${-current * angle}deg)`;
                }, 2500);
                const observer = new MutationObserver(() => {
                    if (getComputedStyle(document.getElementById('searchModal')).display === 'none') {
                        clearInterval(interval);
                        observer.disconnect();
                    }
                });
                observer.observe(document.getElementById('searchModal'), { attributes: true });
            }
            container.classList.add('loaded');
        }
        function mostrarResultadosModal() {
            const pageSize = CONFIG.PAGE_SIZE;
            const totalPages = Math.ceil(searchResults.length / pageSize);
            const start = (currentPageSearch - 1) * pageSize;
            const end = start + pageSize;
            const paginatedResults = searchResults.slice(start, end);
            const isAdminLogged = localStorage.getItem('adminLogged') === 'true';
            const conteoDiv = document.getElementById('conteoResultadosModal');
            if (searchResults.length > 0) {
                conteoDiv.textContent = `Encontrados ${searchResults.length} resultados. El color del Tejuelo indica su estanter√≠a.`;
                conteoDiv.style.display = 'block';
            } else {
                let sugerencia = '';
                if (searchQuery.length > 3) {
                    const similar = catalogo.find(l => {
                        const tituloNorm = normalizarTexto(l.titulo);
                        const queryNorm = normalizarTexto(searchQuery);
                        return tituloNorm.includes(queryNorm.slice(0, -1)) || tituloNorm.includes(queryNorm.slice(1));
                    });
                    if (similar) {
                        sugerencia = `¬øQuiz√°s quer√≠as decir "${similar.titulo}"? Int√©ntalo buscando eso.`;
                    }
                }
                conteoDiv.innerHTML = `No se encontraron resultados para "${searchQuery}". ${sugerencia || 'Intenta con otra palabra clave.'}`;
                conteoDiv.style.display = 'block';
            }
            const resultadosDiv = document.getElementById('resultadosModal');
            resultadosDiv.innerHTML = paginatedResults.map(libro => {
                const esFavorito = favoritos.includes(libro.idRegistro);
                return `
                <div class="libro-modal" role="region" aria-label="Resultado de b√∫squeda para ${libro.titulo}">
                    <div class="portada-section">
                        <div class="portada-container" data-libro-id="${libro.idRegistro}"></div>
                    </div>
                    <div class="info-section">
                        <p><strong>T√≠tulo:</strong> ${libro.titulo}</p>
                        <p><strong>Autor:</strong> ${libro.autor}</p>
                        <p><strong>Categor√≠a:</strong> ${libro.categoria}</p>
                        <p><strong>Tejuelo:</strong> <span class="tejuelo" data-categoria="${libro.categoria.toLowerCase()}">${libro.signatura || 'N/A'}</span></p>
                        <p><strong>Ejemplares Disponibles:</strong> ${libro.copiasDisponibles || 0}</p>
                        <p><strong>Valoraci√≥n:</strong>
                            <span class="estrellas" data-id="${libro.idRegistro}" data-titulo="${encodeURIComponent(libro.titulo)}" role="slider" aria-valuemin="1" aria-valuemax="5" aria-valuenow="0" aria-label="Calificar ${libro.titulo} con estrellas">
                                ${[1,2,3,4,5].map(i => `<span class="estrella" data-value="${i}">‚òÖ</span>`).join('')}
                            </span>
                            <span id="promedio-${libro.idRegistro}" class="promedio">Cargando...</span>
                        </p>
                        <button class="reserva-libro-btn" onclick="openReservationForm()"
                             aria-label="Reservar el libro ${libro.titulo}">Reservar Libro üìö</button>
                        <button class="sinopsis-btn" onclick="mostrarSinopsis('${libro.idRegistro}', '${sanitizeHTML(libro.titulo)}', '${sanitizeHTML(libro.autor)}')"
                                aria-label="Generar sinopsis para ${libro.titulo}">Generar Sinopsis üìù</button>
                        <button class="favorito-btn ${esFavorito ? 'active' : ''}" onclick="toggleFavorito('${libro.idRegistro}')" aria-label="${esFavorito ? 'Quitar' : 'Agregar'} a favoritos el libro ${libro.titulo}">‚ù§Ô∏è</button>
                        <button class="add-cover-btn" onclick="abrirLoginAdmin('${libro.idRegistro}')"
                            aria-label="Abrir panel de admin para subir portada para ${libro.titulo}">+</button>
                        ${isAdminLogged && (libro.portadas || []).length > 0 ? `
                            <button class="delete-cover-btn" onclick="abrirEliminarPortada('${libro.idRegistro}')"
                                aria-label="Eliminar portada para ${libro.titulo}">‚àí</button>
                        ` : ''}
                        <div id="sinopsis-${libro.idRegistro}" style="display: none; margin-top: 10px;"></div>
                    </div>
                </div>
                `;
            }).join('') || '<p>No se encontraron libros en esta p√°gina.</p>';
            const paginationDiv = document.getElementById('searchPagination');
            if (totalPages > 1) {
                let paginationHTML = '';
                paginationHTML += `<button onclick="changePageSearch(${currentPageSearch - 1})" ${currentPageSearch === 1 ? 'disabled' : ''}>Anterior</button>`;
                for (let i = 1; i <= totalPages; i++) {
                    paginationHTML += `<button onclick="changePageSearch(${i})" ${i === currentPageSearch ? 'class="active"' : ''}>${i}</button>`;
                }
                paginationHTML += `<button onclick="changePageSearch(${currentPageSearch + 1})" ${currentPageSearch === totalPages ? 'disabled' : ''}>Siguiente</button>`;
                paginationDiv.innerHTML = paginationHTML;
                paginationDiv.style.display = 'block';
            } else {
                paginationDiv.style.display = 'none';
            }
            requestAnimationFrame(async () => {
                try {
                    const containers = document.querySelectorAll('.portada-container');
                    for (const container of containers) {
                        const idLibro = container.dataset.libroId;
                        await renderPortadas(container, idLibro);
                    }
                } catch (error) {
                    console.error('Error rendering portadas:', error);
                }
            });
            initEstrellas();
            iniciarRotativas();
        }
        function changePageSearch(newPage) {
            const totalPages = Math.ceil(searchResults.length / CONFIG.PAGE_SIZE);
            if (newPage < 1 || newPage > totalPages) return;
            currentPageSearch = newPage;
            mostrarResultadosModal();
        }
        function renderPagination(containerId, currentPage, totalPages, changeFn) {
            const paginationDiv = document.getElementById(containerId);
            if (totalPages <= 1) {
                paginationDiv.style.display = 'none';
                return;
            }
            let html = `<button onclick="${changeFn}(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>Anterior</button>`;
            for (let i = 1; i <= totalPages; i++) {
                html += `<button onclick="${changeFn}(${i})" ${i === currentPage ? 'class="active"' : ''}>${i}</button>`;
            }
            html += `<button onclick="${changeFn}(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>Siguiente</button>`;
            paginationDiv.innerHTML = html;
            paginationDiv.style.display = 'block';
        }
        function changePageFavoritos(newPage) {
            const totalPages = Math.ceil(favoritos.length / CONFIG.PAGE_SIZE);
            if (newPage < 1 || newPage > totalPages) return;
            currentPageFavoritos = newPage;
            abrirModalFavoritos();
        }
        function changePageValorados(newPage) {
            currentPageValorados = newPage;
            abrirModalValorados();
        }
        function toggleFavorito(idLibro) {
            const index = favoritos.indexOf(idLibro);
            if (index > -1) {
                favoritos.splice(index, 1);
                showToast('Libro removido de favoritos', 'warning');
            } else {
                favoritos.push(idLibro);
                showToast('Libro agregado a favoritos', 'success');
            }
            localStorage.setItem('libros_favoritos', JSON.stringify(favoritos));
            mostrarResultadosModal();
        }
        function abrirModalFavoritos() {
            const content = document.getElementById('favoritosContent');
            if (favoritos.length === 0) {
                content.innerHTML = '<p>No hay libros favoritos agregados.</p>';
                document.getElementById('favoritosPagination').style.display = 'none';
                return;
            }
            const librosFavoritos = favoritos.map(id => catalogo.find(l => l.idRegistro === id)).filter(Boolean);
            const totalPages = Math.ceil(librosFavoritos.length / CONFIG.PAGE_SIZE);
            const start = (currentPageFavoritos - 1) * CONFIG.PAGE_SIZE;
            const end = start + CONFIG.PAGE_SIZE;
            const paginated = librosFavoritos.slice(start, end);
            const isAdminLogged = localStorage.getItem('adminLogged') === 'true';
            content.innerHTML = paginated.map(libro => {
                const esFavorito = true;
                return `
                    <div class="libro-modal" role="region" aria-label="Libro favorito: ${libro.titulo}">
                        <div class="portada-section">
                            <div class="portada-container" data-libro-id="${libro.idRegistro}"></div>
                        </div>
                        <div class="info-section">
                            <p><strong>T√≠tulo:</strong> ${libro.titulo || 'Sin t√≠tulo'}</p>
                            <p><strong>Autor:</strong> ${libro.autor || 'Desconocido'}</p>
                            <p><strong>Categor√≠a:</strong> ${libro.categoria || 'No disponible'}</p>
                            <p><strong>Tejuelo:</strong>
                                <span class="tejuelo" data-categoria="${(libro.categoria || 'general').toLowerCase()}">
                                    ${libro.signatura || 'N/A'}
                                </span>
                            </p>
                            <p><strong>Ejemplares Disponibles:</strong> ${libro.copiasDisponibles || 0}</p>
                            <p><strong>Valoraci√≥n:</strong>
                                <span class="estrellas" data-id="${libro.idRegistro}" data-titulo="${encodeURIComponent(libro.titulo || 'Sin t√≠tulo')}" role="slider" aria-valuemin="1" aria-valuemax="5" aria-valuenow="0" aria-label="Calificar ${libro.titulo} con estrellas">
                                    ${[1,2,3,4,5].map(i => `<span class="estrella" data-value="${i}">‚òÖ</span>`).join('')}
                                </span>
                                <span id="promedio-${libro.idRegistro}" class="promedio">Cargando...</span>
                            </p>
                            <button class="reserva-libro-btn" onclick="openReservationForm()"
                                 aria-label="Reservar el libro ${libro.titulo}">Reservar Libro üìö</button>
                            <button class="sinopsis-btn" onclick="mostrarSinopsis('${libro.idRegistro}', '${sanitizeHTML(libro.titulo || 'Sin t√≠tulo')}', '${sanitizeHTML(libro.autor || 'Desconocido')}')"
                                    aria-label="Generar sinopsis para ${libro.titulo}">Generar Sinopsis üìù</button>
                            <button class="favorito-btn active" onclick="toggleFavorito('${libro.idRegistro}')" aria-label="Quitar de favoritos el libro ${libro.titulo}">‚ù§Ô∏è</button>
                            <button class="add-cover-btn" onclick="abrirLoginAdmin('${libro.idRegistro}')"
                                aria-label="Abrir panel de admin para subir portada para ${libro.titulo}">+</button>
                            ${isAdminLogged && (libro.portadas || []).length > 0 ? `
                                <button class="delete-cover-btn" onclick="abrirEliminarPortada('${libro.idRegistro}')"
                                    aria-label="Eliminar portada para ${libro.titulo}">‚àí</button>
                            ` : ''}
                            <div id="sinopsis-${libro.idRegistro}" style="display: none; margin-top: 10px;"></div>
                        </div>
                    </div>
                `;
            }).join('') || '<p>No hay libros en esta p√°gina.</p>';
            requestAnimationFrame(async () => {
                const containers = content.querySelectorAll('.portada-container');
                for (const container of containers) {
                    const idLibro = container.dataset.libroId;
                    await renderPortadas(container, idLibro);
                }
                initEstrellas();
            });
            renderPagination('favoritosPagination', currentPageFavoritos, totalPages, 'changePageFavoritos');
            document.getElementById('favoritosModal').style.display = 'block';
            setupFocusTrap('favoritosModal');
        }
        async function abrirModalValorados() {
            const content = document.getElementById('valoradosContent');
            content.innerHTML = '<p>Cargando libros m√°s valorados...</p>';
            document.getElementById('valoradosModal').style.display = 'block';
            setupFocusTrap('valoradosModal');
            try {
                const url = `${CONFIG.WEB_APP_URL}?action=getTopCalificados&limit=10&t=${Date.now()}`;
                const response = await fetch(url);
                const text = await response.text();
                let data;
                try { data = JSON.parse(text); }
                catch (e) { throw new Error('JSON inv√°lido: ' + text); }
                if (data.error) throw new Error(data.error);
                if (!Array.isArray(data)) {
                    content.innerHTML = '<p>No hay calificaciones a√∫n.</p>';
                    return;
                }
                if (data.length === 0) {
                    content.innerHTML = '<p>No hay calificaciones suficientes a√∫n.</p>';
                    return;
                }
                const catalogoConId = catalogo.map(l => ({
                    ...l,
                    idRegistro: String(l.idRegistro || l.id_documento || '')
                }));
                const librosValidos = data
                    .map(top => {
                        const libro = catalogoConId.find(l => l.idRegistro === String(top.id));
                        if (!libro) {
                            console.warn('Libro no encontrado en cat√°logo:', top.id, top.titulo);
                            return null;
                        }
                        return { ...libro, ...top };
                    })
                    .filter(Boolean);
                if (librosValidos.length === 0) {
                    content.innerHTML = '<p>No hay libros valorados en el cat√°logo.</p>';
                    return;
                }
                const totalPages = Math.ceil(librosValidos.length / CONFIG.PAGE_SIZE);
                const start = (currentPageValorados - 1) * CONFIG.PAGE_SIZE;
                const end = start + CONFIG.PAGE_SIZE;
                const paginated = librosValidos.slice(start, end);
                const isAdminLogged = localStorage.getItem('adminLogged') === 'true';
                content.innerHTML = paginated.map(libro => {
                    const esFavorito = favoritos.includes(libro.idRegistro);
                    return `
                        <div class="libro-modal" role="region" aria-label="Libro m√°s valorado: ${libro.titulo}">
                            <div class="portada-section">
                                <div class="portada-container" data-libro-id="${libro.idRegistro}"></div>
                            </div>
                            <div class="info-section">
                                <p><strong>T√≠tulo:</strong> ${libro.titulo || 'Sin t√≠tulo'}</p>
                                <p><strong>Autor:</strong> ${libro.autor || 'Desconocido'}</p>
                                <p><strong>Categor√≠a:</strong> ${libro.categoria || 'No disponible'}</p>
                                <p><strong>Tejuelo:</strong>
                                    <span class="tejuelo" data-categoria="${(libro.categoria || 'general').toLowerCase()}">
                                        ${libro.signatura || 'N/A'}
                                    </span>
                                </p>
                                <p><strong>Ejemplares Disponibles:</strong> ${libro.copiasDisponibles || 0}</p>
                                <p><strong>Valoraci√≥n:</strong>
                                    <span class="estrellas" data-id="${libro.idRegistro}" data-titulo="${encodeURIComponent(libro.titulo || 'Sin t√≠tulo')}" role="slider" aria-valuemin="1" aria-valuemax="5" aria-valuenow="0" aria-label="Calificar ${libro.titulo} con estrellas">
                                        ${[1,2,3,4,5].map(i => `<span class="estrella" data-value="${i}">‚òÖ</span>`).join('')}
                                    </span>
                                    <span id="promedio-valorados-${libro.idRegistro}" class="promedio">${libro.promedio.toFixed(1)} ‚òÖ (${libro.numVotos} voto${libro.numVotos > 1 ? 's' : ''})</span>
                                </p>
                                <button class="reserva-libro-btn" onclick="openReservationForm()"
                                     aria-label="Reservar el libro ${libro.titulo}">Reservar Libro üìö</button>
                                <button class="sinopsis-btn" onclick="mostrarSinopsis('${libro.idRegistro}', '${sanitizeHTML(libro.titulo || 'Sin t√≠tulo')}', '${sanitizeHTML(libro.autor || 'Desconocido')}')"
                                        aria-label="Generar sinopsis para ${libro.titulo}">Generar Sinopsis üìù</button>
                                <button class="favorito-btn ${esFavorito ? 'active' : ''}" onclick="toggleFavorito('${libro.idRegistro}')" aria-label="${esFavorito ? 'Quitar' : 'Agregar'} a favoritos el libro ${libro.titulo}">‚ù§Ô∏è</button>
                                <button class="add-cover-btn" onclick="abrirLoginAdmin('${libro.idRegistro}')"
                                    aria-label="Abrir panel de admin para subir portada para ${libro.titulo}">+</button>
                                ${isAdminLogged && (libro.portadas || []).length > 0 ? `
                                    <button class="delete-cover-btn" onclick="abrirEliminarPortada('${libro.idRegistro}')"
                                        aria-label="Eliminar portada para ${libro.titulo}">‚àí</button>
                                ` : ''}
                                <div id="sinopsis-${libro.idRegistro}" style="display: none; margin-top: 10px;"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                requestAnimationFrame(async () => {
                    for (const container of content.querySelectorAll('.portada-container')) {
                        await renderPortadas(container, container.dataset.libroId);
                    }
                    initEstrellas();
                });
                renderPagination('valoradosPagination', currentPageValorados, totalPages, 'changePageValorados');
            } catch (error) {
                console.error('Error:', error);
                content.innerHTML = `<p><strong>Error:</strong> ${error.message}</p>`;
            }
        }
        async function generarSinopsis(titulo, autor, idRegistro) {
            const cacheKey = `sinopsis_${normalizarTexto(titulo)}_${normalizarTexto(autor)}`;
            if (cacheRespuestas[cacheKey]) {
                return { texto: cacheRespuestas[cacheKey], mostrarReservaBtn: false, mostrarSolicitudBtn: false };
            }
            const systemPrompt = `Eres Hipat-IA, una bibliotecaria virtual del IES Carpe Diem.
            Proporciona una sinopsis breve (100-200 palabras) del libro "${titulo}" de ${autor}.
            Si no conoces el libro, genera una sinopsis creativa basada en el t√≠tulo y el contexto general.
            Termina con una oraci√≥n completa con punto. Usa un tono c√°lido y atractivo, con emojis.`;
            const contents = [
                { parts: [{ text: systemPrompt }], role: 'model' },
                { parts: [{ text: `Dame la sinopsis de "${titulo}" de ${autor}.` }], role: 'user' }
            ];
            let respuesta = null;
            if (!MODELO_FUNCIONAL || MODELO_FUNCIONAL === 'null') {
                showToast('Buscando un modelo de Gemini funcional...', 'warning');
                for (const modelo of CONFIG.MODELOS_A_PROBAR) {
                    respuesta = await probarModelo(modelo, contents);
                    if (respuesta) {
                        showToast(`¬°Modelo ${modelo} funciona! Us√°ndose de ahora en adelante.`, 'success');
                        break;
                    }
                }
                if (!respuesta) {
                    respuesta = 'No pude conectar con la API de Gemini, int√©ntalo m√°s tarde.';
                }
            } else {
                respuesta = await probarModelo(MODELO_FUNCIONAL, contents);
                if (!respuesta) {
                    console.warn(`Modelo guardado ${MODELO_FUNCIONAL} fall√≥, buscando nuevo modelo...`);
                    localStorage.removeItem('gemini_modelo_funcional');
                    MODELO_FUNCIONAL = null;
                    return generarSinopsis(titulo, autor, idRegistro);
                }
            }
            cacheRespuestas[cacheKey] = respuesta;
            localStorage.setItem('hipatia_cache', JSON.stringify(cacheRespuestas));
            return { texto: respuesta, mostrarReservaBtn: false, mostrarSolicitudBtn: false };
        }
        async function mostrarSinopsis(idRegistro, titulo, autor) {
            const sinopsisDiv = document.getElementById(`sinopsis-${idRegistro}`);
            sinopsisDiv.innerHTML = '<p style="font-style: italic; color: var(--text-secondary);">Generando sinopsis...</p>';
            sinopsisDiv.style.display = 'block';
            const { texto, mostrarReservaBtn, mostrarSolicitudBtn } = await generarSinopsis(titulo, autor, idRegistro);
            const mensajeId = mensajeActualId++;
            const partes = dividirTexto(texto, 'sinopsis');
            respuestasPendientes[mensajeId] = partes;
            sinopsisDiv.innerHTML = marked.parse(sanitizeHTML(`**Sinopsis (Parte 1/${partes.length})**:\n${partes[0].texto}`));
            if (partes.length > 1) {
                const proseguirBtn = document.createElement('button');
                proseguirBtn.className = 'proseguir-btn';
                proseguirBtn.textContent = 'Proseguir sinopsis';
                proseguirBtn.setAttribute('aria-label', `Mostrar la parte 2 de ${partes.length} de la sinopsis de ${titulo}`);
                proseguirBtn.onclick = () => mostrarSiguienteParteSinopsis(idRegistro, mensajeId, 2, partes);
                sinopsisDiv.appendChild(proseguirBtn);
            }
        }
        function mostrarSiguienteParteSinopsis(idRegistro, mensajeId, parteActual, partes) {
            const sinopsisDiv = document.getElementById(`sinopsis-${idRegistro}`);
            if (parteActual <= partes.length) {
                sinopsisDiv.innerHTML = marked.parse(sanitizeHTML(`**Sinopsis (Parte ${parteActual}/${partes.length})**:\n${partes[parteActual - 1].texto}`));
                if (parteActual < partes.length) {
                    const proseguirBtn = document.createElement('button');
                    proseguirBtn.className = 'proseguir-btn';
                    proseguirBtn.textContent = 'Proseguir sinopsis';
                    proseguirBtn.setAttribute('aria-label', `Mostrar la parte ${parteActual + 1} de ${partes.length} de la sinopsis`);
                    proseguirBtn.onclick = () => mostrarSiguienteParteSinopsis(idRegistro, mensajeId, parteActual + 1, partes);
                    sinopsisDiv.appendChild(proseguirBtn);
                }
            }
        }
        function dividirTexto(texto, tipo) {
            const maxLength = 500;
            const partes = [];
            let parteActual = '';
            let contadorPalabras = 0;
            const palabras = texto.split(' ');
            for (const palabra of palabras) {
                if (contadorPalabras + palabra.length > maxLength) {
                    partes.push({ tipo, texto: parteActual.trim() });
                    parteActual = palabra + ' ';
                    contadorPalabras = palabra.length + 1;
                } else {
                    parteActual += palabra + ' ';
                    contadorPalabras += palabra.length + 1;
                }
            }
            if (parteActual.trim()) {
                partes.push({ tipo, texto: parteActual.trim() });
            }
            return partes.length > 0 ? partes : [{ tipo, texto }];
        }
        function agregarMensaje(texto, esUsuario = false, esTemporal = false, partes = null, mensajeId = null, parteActual = 1, totalPartes = 1, libroBuscado = null, mostrarReservaBtn = false, mostrarSolicitudBtn = false) {
            const chatMensajes = document.getElementById('chatMensajes');
            const mensajes = Array.from(chatMensajes.getElementsByClassName('mensaje'));
            if (mensajes.length > 50) {
                mensajes[0].remove();
            }
            const mensajeDiv = document.createElement('div');
            mensajeDiv.className = `mensaje ${esUsuario ? 'user' : 'bot'}${esTemporal ? ' temporal typing' : ''}`;
            let mensajeTexto = esUsuario ? texto : texto;
            if (esTemporal) {
                mensajeDiv.innerHTML = '<span class="typing-dots">Hipat-IA est√° buscando en la estanter√≠a</span>';
            } else if (!esUsuario && !esTemporal && partes) {
                mensajeTexto = `**${partes[parteActual - 1].tipo.charAt(0).toUpperCase() + partes[parteActual - 1].tipo.slice(1)} (Parte ${parteActual}/${totalPartes})**:\n${partes[parteActual - 1].texto}`;
            }
            if (!esTemporal) {
                mensajeDiv.innerHTML = esUsuario ? sanitizeHTML(mensajeTexto) : marked.parse(sanitizeHTML(mensajeTexto));
            }
            if (!esUsuario && !esTemporal) {
                if (partes && parteActual < totalPartes) {
                    const proseguirBtn = document.createElement('button');
                    proseguirBtn.className = 'proseguir-btn';
                    proseguirBtn.textContent = 'Proseguir respuesta';
                    proseguirBtn.setAttribute('aria-label', `Mostrar la parte ${parteActual + 1} de ${totalPartes} de la respuesta`);
                    proseguirBtn.onclick = () => mostrarSiguienteParte(mensajeId, parteActual + 1);
                    mensajeDiv.appendChild(proseguirBtn);
                }
                if (libroBuscado) {
                    const buscarBtn = document.createElement('button');
                    buscarBtn.className = 'buscar-libro-btn';
                    buscarBtn.textContent = 'Abrir Cat√°logo üîç';
                    buscarBtn.setAttribute('aria-label', `Abrir ventana de b√∫squeda con resultados para ${libroBuscado}`);
                    buscarBtn.onclick = () => abrirBuscadorLibro(libroBuscado);
                    mensajeDiv.appendChild(buscarBtn);
                }
                if (mostrarReservaBtn) {
                    const reservaBtn = document.createElement('button');
                    reservaBtn.className = 'reserva-libro-btn';
                    reservaBtn.textContent = 'Reserva de Libros üìö';
                    reservaBtn.setAttribute('aria-label', `Abrir formulario de reserva de libros`);
                    reservaBtn.onclick = () => openReservationForm();
                    mensajeDiv.appendChild(reservaBtn);
                }
                if (mostrarSolicitudBtn) {
                    const solicitudBtn = document.createElement('button');
                    solicitudBtn.className = 'solicitud-libro-btn';
                    solicitudBtn.textContent = 'Solicitud de Libros Nuevos üó≥Ô∏è';
                    solicitudBtn.setAttribute('aria-label', `Abrir formulario de solicitud de libros nuevos`);
                    solicitudBtn.onclick = () => openRequestForm();
                    mensajeDiv.appendChild(solicitudBtn);
                }
            }
            chatMensajes.appendChild(mensajeDiv);
            chatMensajes.scrollTop = chatMensajes.scrollHeight;
            if (!esTemporal) {
                historialMensajes.push({ role: esUsuario ? 'user' : 'assistant', content: texto });
                if (historialMensajes.length > 6) {
                    historialMensajes = historialMensajes.slice(-6);
                }
            }
            return mensajeDiv;
        }
        function mostrarSiguienteParte(mensajeId, parteActual) {
            const partes = respuestasPendientes[mensajeId];
            if (partes && parteActual <= partes.length) {
                const libroBuscado = partes[0].libroBuscado || null;
                const mostrarReservaBtn = partes[0].texto.includes('[RESERVA]');
                const mostrarSolicitudBtn = partes[0].texto.includes('[SOLICITUD]');
                agregarMensaje('', false, false, partes, mensajeId, parteActual, partes.length, libroBuscado, mostrarReservaBtn, mostrarSolicitudBtn);
            }
        }
        function formatearResultados(resultados, libroBuscado) {
            if (!resultados.length) {
                return {
                    texto: `Quiz√°s haya algo de "${libroBuscado}" en el cat√°logo. Usa el bot√≥n **Solicitud de Libros Nuevos** para proponer el libro si no lo tenemos.`,
                    mostrarSolicitudBtn: true,
                    libroBuscado
                };
            }
            const libro = resultados[0];
            return {
                texto: `Hay ${libro.copiasTotales || 0} ejemplares totales de "${libro.titulo}", de los cuales ${libro.copiasDisponibles || 0} est√°n disponibles. Usa el bot√≥n **Reserva de Libros** para reservarlo. ¬øQuieres abrir la ventana de b√∫squeda para ver m√°s detalles?`,
                mostrarReservaBtn: true,
                libroBuscado
            };
        }
        function generarRecomendacion(intencion) {
            if (!catalogo.length) {
                return {
                    texto: 'El cat√°logo no est√° disponible ahora mismo. Usa el bot√≥n **Solicitud de Libros Nuevos** para proponer un libro. ¬øOtro g√©nero?',
                    libroBuscado: null,
                    mostrarSolicitudBtn: true
                };
            }
            let librosFiltrados = catalogo;
            let descripcion = '';
            if (intencion === 'recomendacion_fantasia') {
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === 'narrativa');
                descripcion = 'una emocionante obra de narrativa, ideal para amantes de la fantas√≠a y la aventura.';
            } else if (intencion === 'recomendacion_poesia') {
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === 'poesia');
                descripcion = 'un hermoso poemario que captura emociones profundas.';
            } else if (intencion === 'recomendacion_narrativa') {
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === 'narrativa');
                descripcion = 'una novela cautivadora que te sumergir√° en una gran historia.';
            } else if (intencion === 'recomendacion_teatro') {
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === 'teatro');
                descripcion = 'una obra teatral fascinante, llena de di√°logos y emociones.';
            } else if (intencion === 'recomendacion_comic') {
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === 'c√≥mic');
                descripcion = 'un c√≥mic vibrante con historias visuales emocionantes.';
            } else if (intencion === 'recomendacion_literatura_inglesa') {
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === 'literatura inglesa');
                descripcion = 'una obra en ingl√©s que destaca por su riqueza literaria.';
            } else if (intencion === 'recomendacion_deportes') {
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === 'deportes');
                descripcion = 'un libro apasionante sobre deportes, perfecto para entusiastas.';
            } else {
                const categorias = ['Narrativa', 'Poes√≠a', 'Teatro', 'Literatura inglesa', 'Enciclopedias', 'C√≥mic', 'Deportes', 'Lecturas Graduadas'];
                const categoriaAleatoria = categorias[Math.floor(Math.random() * categorias.length)];
                librosFiltrados = catalogo.filter(libro => normalizarTexto(libro.categoria) === normalizarTexto(categoriaAleatoria));
                descripcion = `una obra destacada de ${categoriaAleatoria.toLowerCase()}, perfecta para explorar algo nuevo.`;
            }
            if (librosFiltrados.length === 0) {
                return {
                    texto: `No encontr√© libros en esa categor√≠a en el cat√°logo. Usa el bot√≥n **Solicitud de Libros Nuevos** para proponer uno. ¬øOtro tipo de libro?`,
                    libroBuscado: null,
                    mostrarSolicitudBtn: true
                };
            }
            const libro = librosFiltrados[Math.floor(Math.random() * librosFiltrados.length)];
            const texto = `Te recomiendo *${libro.titulo}* de ${libro.autor} (${libro.categoria}). Es ${descripcion} Hay ${libro.copiasTotales || 0} ejemplares totales, de los cuales ${libro.copiasDisponibles || 0} est√°n disponibles. Usa el bot√≥n **Reserva de Libros** para reservarlo. ¬øQuieres abrir la ventana de b√∫squeda para ver m√°s detalles?`;
            return {
                texto,
                libroBuscado: libro.titulo,
                mostrarReservaBtn: true
            };
        }
        function detectarIntencion(query) {
            const lowerQuery = normalizarTexto(query);
            if (lowerQuery.includes('cuantos') || lowerQuery.includes('ejemplares') || lowerQuery.includes('copias') || lowerQuery.includes('disponibles') || lowerQuery.includes('libros')) return 'ejemplares';
            if (lowerQuery.includes('sinopsis')) return 'sinopsis';
            if (lowerQuery.includes('resumen')) return 'resumen';
            if (lowerQuery.includes('rese√±a') || lowerQuery.includes('critica') || lowerQuery.includes('opinion')) return 'rese√±a';
            if (lowerQuery.includes('recomendaciones') || lowerQuery.includes('recomiendame') || lowerQuery.includes('recomi√©ndame') || lowerQuery.includes('sugerencias')) return 'recomendaciones';
            if (lowerQuery.includes('fantasia') || lowerQuery.includes('aventura')) return 'recomendacion_fantasia';
            if (lowerQuery.includes('poesia') || lowerQuery.includes('poema')) return 'recomendacion_poesia';
            if (lowerQuery.includes('narrativa') || lowerQuery.includes('novela')) return 'recomendacion_narrativa';
            if (lowerQuery.includes('teatro')) return 'recomendacion_teatro';
            if (lowerQuery.includes('comic') || lowerQuery.includes('c√≥mic')) return 'recomendacion_comic';
            if (lowerQuery.includes('literatura inglesa') || lowerQuery.includes('libros en ingles') || lowerQuery.includes('libros en ingl√©s')) return 'recomendacion_literatura_inglesa';
            if (lowerQuery.includes('deportes')) return 'recomendacion_deportes';
            if (lowerQuery.includes('reservar') || lowerQuery.includes('reserva')) return 'reservas';
            if (lowerQuery.includes('solicitar') || lowerQuery.includes('proponer') || lowerQuery.includes('nuevo libro')) return 'solicitar';
            return 'general';
        }
        async function probarModelo(modelo, contents) {
            try {
                const response = await fetch(`${CONFIG.BASE_URL}${modelo}:generateContent?key=${CONFIG.API_KEY}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents })
                });
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error.message);
                if (data.candidates && data.candidates.length > 0) {
                    const contenido = data.candidates[0].content;
                    if (contenido && contenido.parts && contenido.parts.length > 0) {
                        localStorage.setItem('gemini_modelo_funcional', modelo);
                        MODELO_FUNCIONAL = modelo;
                        return contenido.parts.map(part => part.text).join(' ');
                    }
                }
                return null;
            } catch (error) {
                console.error(`Error con el modelo ${modelo}:`, error);
                return null;
            }
        }
        async function consultarAPI(mensaje, intencion, contexto) {
            const historialResumido = historialMensajes.length > 4 ?
                `Resumen del historial: El usuario pregunt√≥ sobre ${historialMensajes.filter(m => m.role === 'user').map(m => m.content).join(', ')}. Contin√∫a la conversaci√≥n de forma natural.\n` :
                historialMensajes.map(msg => `${msg.role === 'user' ? 'Usuario' : 'Hipat-IA'}: ${msg.content}`).join('\n');
            const systemPrompt = `Eres Hipat-IA, una bibliotecaria virtual entusiasta del IES Carpe Diem.
            Respondes en espa√±ol con un tono c√°lido, din√°mico y profesional, como una amiga conocedora de libros. Nunca repitas "Hola, soy Hipat-IA". Usa el cat√°logo y el historial para respuestas relevantes y naturales.
            **Contexto del cat√°logo**: ${contexto}
            **Historial de la conversaci√≥n**: ${historialResumido}
            **Instrucciones**:
            - **Sinopsis**: Da un resumen breve de 100-200 palabras, usando el cat√°logo si est√° disponible o conocimiento general. Termina en una oraci√≥n completa con punto.
            - **Resumen**: Da un resumen breve de 100-200 palabras, estructurado para ser claro y conciso, usando el cat√°logo si est√° disponible o conocimiento general. Termina en una oraci√≥n completa con punto.
            - **Rese√±a**: Ofrece una opini√≥n cr√≠tica de 100-200 palabras, destacando importancia y caracter√≠sticas. Termina en una oraci√≥n completa con punto.
            - **General**: Responde en 100-200 palabras con informaci√≥n relevante, clara y completa. Termina en una oraci√≥n completa con punto.
            - **Reservas**: Indica que se puede reservar un libro usando el bot√≥n **Reserva de Libros**. Incluye una se√±al [RESERVA] al final de la respuesta.
            - **Solicitar un libro**: Indica que se puede proponer un nuevo libro usando el bot√≥n **Solicitud de Libros Nuevos**. Incluye una se√±al [SOLICITUD] al final de la respuesta.
            - Usa emojis (üìñ, ‚ú®) para un toque amigable.
            - Termina con una pregunta breve, como "¬øOtro libro?" o "¬øM√°s detalles?".`;
            const contents = [
                { parts: [{ text: systemPrompt }], role: 'model' },
                ...historialMensajes.map(msg => ({
                    parts: [{ text: msg.content }],
                    role: msg.role === 'user' ? 'user' : 'model'
                })),
                { parts: [{ text: mensaje }], role: 'user' }
            ];
            let respuesta = null;
            if (!MODELO_FUNCIONAL || MODELO_FUNCIONAL === 'null') {
                showToast('Buscando un modelo de Gemini funcional...', 'warning');
                for (const modelo of CONFIG.MODELOS_A_PROBAR) {
                    respuesta = await probarModelo(modelo, contents);
                    if (respuesta) {
                        showToast(`¬°Modelo ${modelo} funciona! Us√°ndose de ahora en adelante.`, 'success');
                        break;
                    }
                }
                if (!respuesta) {
                    respuesta = intencion === 'sinopsis' ? 'No pude conectar, int√©ntalo m√°s tarde.' :
                            intencion === 'resumen' ? 'No pude conectar, int√©ntalo m√°s tarde.' :
                            intencion === 'rese√±a' ? 'No pude conectar, int√©ntalo m√°s tarde.' :
                            'No pude conectar, int√©ntalo m√°s tarde.';
                }
            } else {
                respuesta = await probarModelo(MODELO_FUNCIONAL, contents);
                if (!respuesta) {
                    console.warn(`Modelo guardado ${MODELO_FUNCIONAL} fall√≥, buscando nuevo modelo...`);
                    localStorage.removeItem('gemini_modelo_funcional');
                    MODELO_FUNCIONAL = null;
                    return consultarAPI(mensaje, intencion, contexto);
                }
            }
            return {
                texto: respuesta,
                mostrarReservaBtn: respuesta.includes('[RESERVA]'),
                mostrarSolicitudBtn: respuesta.includes('[SOLICITUD]')
            };
        }
        async function enviarMensaje() {
            if (!catalogo.length) {
                showToast('El cat√°logo a√∫n est√° cargando. Intenta de nuevo en un momento.', 'warning');
                return;
            }
            const mensaje = sanitizeHTML(document.getElementById('chatInput').value.trim());
            if (!mensaje) {
                showToast('Por favor, escribe un mensaje.', 'warning');
                return;
            }
            agregarMensaje(mensaje, true);
            document.getElementById('chatInput').value = '';
            const escribiendoDiv = agregarMensaje('Hipat-IA est√° buscando en la estanter√≠a...', false, true);
            const intencion = detectarIntencion(mensaje);
            const cacheKey = `${intencion}_${normalizarTexto(mensaje)}`;
            const mensajeId = mensajeActualId++;
            if (intencion === 'ejemplares') {
                const libroBuscado = extraerLibroDeConsulta(mensaje);
                if (!libroBuscado) {
                    escribiendoDiv.classList.remove('typing');
                    setTimeout(() => escribiendoDiv.remove(), 300);
                    const respuesta = 'No entend√≠ el t√≠tulo del libro. ¬øPuedes especificarlo, por ejemplo, "cu√°ntos ejemplares hay de La Colmena"?';
                    agregarMensaje(respuesta);
                    return;
                }
                const resultados = buscarLibros(libroBuscado, true);
                escribiendoDiv.classList.remove('typing');
                setTimeout(() => escribiendoDiv.remove(), 300);
                const { texto, mostrarReservaBtn, mostrarSolicitudBtn, libroBuscado: libro } = formatearResultados(resultados, libroBuscado);
                const partes = dividirTexto(texto, 'respuesta');
                respuestasPendientes[mensajeId] = partes;
                agregarMensaje('', false, false, partes, mensajeId, 1, partes.length, libro, mostrarReservaBtn, mostrarSolicitudBtn);
                cacheRespuestas[cacheKey] = texto;
                localStorage.setItem('hipatia_cache', JSON.stringify(cacheRespuestas));
                return;
            }
            if (['recomendaciones', 'recomendacion_fantasia', 'recomendacion_poesia', 'recomendacion_narrativa', 'recomendacion_teatro', 'recomendacion_comic', 'recomendacion_literatura_inglesa', 'recomendacion_deportes'].includes(intencion)) {
                escribiendoDiv.classList.remove('typing');
                setTimeout(() => escribiendoDiv.remove(), 300);
                const { texto, libroBuscado, mostrarReservaBtn, mostrarSolicitudBtn } = generarRecomendacion(intencion);
                const partes = dividirTexto(texto, 'recomendacion');
                respuestasPendientes[mensajeId] = partes;
                agregarMensaje('', false, false, partes, mensajeId, 1, partes.length, libroBuscado, mostrarReservaBtn, mostrarSolicitudBtn);
                cacheRespuestas[cacheKey] = texto;
                localStorage.setItem('hipatia_cache', JSON.stringify(cacheRespuestas));
                return;
            }
            if (intencion === 'reservas') {
                escribiendoDiv.classList.remove('typing');
                setTimeout(() => escribiendoDiv.remove(), 300);
                const texto = `Puedes reservar un libro usando el bot√≥n **Reserva de Libros**. ¬øQuieres buscar un libro espec√≠fico?`;
                const partes = dividirTexto(texto, 'respuesta');
                respuestasPendientes[mensajeId] = partes;
                agregarMensaje('', false, false, partes, mensajeId, 1, partes.length, null, true, false);
                cacheRespuestas[cacheKey] = texto;
                localStorage.setItem('hipatia_cache', JSON.stringify(cacheRespuestas));
                return;
            }
            if (intencion === 'solicitar') {
                escribiendoDiv.classList.remove('typing');
                setTimeout(() => escribiendoDiv.remove(), 300);
                const texto = `Puedes proponer un libro nuevo usando el bot√≥n **Solicitud de Libros Nuevos**. ¬øQu√© libro te gustar√≠a sugerir?`;
                const partes = dividirTexto(texto, 'respuesta');
                respuestasPendientes[mensajeId] = partes;
                agregarMensaje('', false, false, partes, mensajeId, 1, partes.length, null, false, true);
                cacheRespuestas[cacheKey] = texto;
                localStorage.setItem('hipatia_cache', JSON.stringify(cacheRespuestas));
                return;
            }
            if (cacheRespuestas[cacheKey]) {
                escribiendoDiv.classList.remove('typing');
                setTimeout(() => escribiendoDiv.remove(), 300);
                const partes = dividirTexto(cacheRespuestas[cacheKey], intencion);
                respuestasPendientes[mensajeId] = partes;
                agregarMensaje('', false, false, partes, mensajeId, 1, partes.length, null, cacheRespuestas[cacheKey].includes('[RESERVA]'), cacheRespuestas[cacheKey].includes('[SOLICITUD]'));
                return;
            }
            const resultadosCatalogo = buscarLibros(mensaje);
            let contexto = '';
            if (resultadosCatalogo.length > 0) {
                contexto = `Resultados del cat√°logo de la Biblioteca Hipatia:\n${resultadosCatalogo.map((libro, index) => `
                    - **T√≠tulo**: ${libro.titulo}
                    **Autor**: ${libro.autor}
                    **Categor√≠a**: ${libro.categoria}
                    **Tejuelo**: ${libro.signatura}
                    **Ejemplares totales**: ${libro.copiasTotales}
                    **Disponibles**: ${libro.copiasDisponibles}
                `).join('\n')}\n\n`;
            } else if (!catalogo.length) {
                contexto = 'El cat√°logo no est√° disponible, pero puedo ofrecer sinopsis o recomendaciones generales. Usa el bot√≥n **Solicitud de Libros Nuevos** para proponer un libro.\n\n';
            }
            const { texto, mostrarReservaBtn, mostrarSolicitudBtn } = await consultarAPI(mensaje, intencion, contexto);
            escribiendoDiv.classList.remove('typing');
            setTimeout(() => escribiendoDiv.remove(), 300);
            const partes = dividirTexto(texto, intencion);
            respuestasPendientes[mensajeId] = partes;
            agregarMensaje('', false, false, partes, mensajeId, 1, partes.length, null, mostrarReservaBtn, mostrarSolicitudBtn);
            cacheRespuestas[cacheKey] = texto;
            localStorage.setItem('hipatia_cache', JSON.stringify(cacheRespuestas));
        }
        function abrirLoginAdmin(idLibro) {
            const isAdminLogged = localStorage.getItem('adminLogged') === 'true';
            const loginTime = localStorage.getItem('adminLoginTime');
            const LOGIN_DURATION = 24 * 60 * 60 * 1000;
            if (isAdminLogged && loginTime && (Date.now() - parseInt(loginTime) < LOGIN_DURATION)) {
                mostrarFormularioSubida(idLibro);
                return;
            }
            localStorage.removeItem('adminLogged');
            localStorage.removeItem('adminLoginTime');
            localStorage.removeItem('githubToken');
            const content = document.getElementById('adminContent');
            content.innerHTML = `
                <div class="admin-form">
                    <p><strong>Login de Administrador</strong></p>
                    <input type="text" id="admin-user" placeholder="Usuario" autocomplete="username">
                    <input type="password" id="admin-pass" placeholder="Contrase√±a" autocomplete="current-password">
                    <input type="text" id="github-token" placeholder="GitHub Token" autocomplete="off">
                    <button class="admin-login-btn" onclick="validarAdmin('${idLibro}')">Iniciar sesi√≥n</button>
                    <button class="admin-cancel-btn" onclick="cerrarModalAdmin()">Cancelar</button>
                </div>
            `;
            document.getElementById('adminModal').style.display = 'block';
            setupFocusTrap('adminModal');
            document.getElementById('admin-user').focus();
        }
        function validarAdmin(idLibro) {
            const user = document.getElementById('admin-user').value.trim();
            const pass = document.getElementById('admin-pass').value;
            const githubToken = document.getElementById('github-token').value.trim();
            if (user === CONFIG.ADMIN_USER && pass === CONFIG.ADMIN_PASS && githubToken) {
                localStorage.setItem('adminLogged', 'true');
                localStorage.setItem('adminLoginTime', Date.now());
                localStorage.setItem('githubToken', githubToken);
                cerrarModalAdmin();
                mostrarFormularioSubida(idLibro);
                showToast('Login correcto. Sube la portada.', 'success');
            } else {
                showToast('Credenciales incorrectas o token faltante.', 'error');
            }
        }
        function mostrarFormularioSubida(idLibro) {
            const content = document.getElementById('adminContent');
            const libro = catalogo.find(l => l.idRegistro === idLibro);
            content.innerHTML = `
                <div class="admin-form">
                    <p><strong>Subir portada para:</strong> <em>${libro?.titulo || 'Libro'}</em></p>
                    <input type="file" id="cover-file" accept="image/*">
                    <button class="admin-login-btn" onclick="subirPortada('${idLibro}')">Subir portada</button>
                    <button class="admin-cancel-btn" onclick="cerrarModalAdmin()">Cancelar</button>
                    <p id="upload-status" style="margin-top:8px; font-size:0.9em;"></p>
                </div>
            `;
            document.getElementById('adminModal').style.display = 'block';
            setupFocusTrap('adminModal');
        }
        async function subirPortada(idLibro) {
            const token = localStorage.getItem('githubToken');
            if (!token) {
                showToast('Token de GitHub no encontrado. Inicia sesi√≥n nuevamente.', 'error');
                return;
            }
            const fileInput = document.getElementById('cover-file');
            const status = document.getElementById('upload-status');
            if (!fileInput.files[0]) {
                status.textContent = 'Selecciona una imagen.';
                status.style.color = 'red';
                return;
            }
            const file = fileInput.files[0];
            if (!file.type.startsWith('image/')) {
                status.textContent = 'Archivo no es una imagen v√°lida.';
                status.style.color = 'red';
                return;
            }
            status.textContent = 'Procesando y subiendo a GitHub...';
            status.style.color = 'blue';
            try {
                const base64Content = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        const img = new Image();
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const ctx = canvas.getContext('2d');
                            canvas.width = 300;
                            canvas.height = 450;
                            ctx.drawImage(img, 0, 0, 300, 450);
                            resolve(canvas.toDataURL('image/jpeg', 0.8).split(',')[1]);
                        };
                        img.src = reader.result;
                    };
                    reader.onerror = reject;
                    reader.readAsDataURL(file);
                });
                const fileName = `${idLibro}_${Date.now()}.jpg`;
                const uploadUrl = `${CONFIG.GITHUB_API_URL}${fileName}`;
                const response = await fetch(uploadUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Subir portada para libro ${idLibro} - ${file.name}`,
                        content: base64Content
                    })
                });
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Error GitHub: ${response.status} - ${errorData.message || 'Desconocido'}`);
                }
                const timestamp = Date.now();
                const publicUrl = `https://cdn.jsdelivr.net/gh/IES-Carpe-Diem/Biblioteca-Hipatia@main/portadas/${fileName}`;
                const cacheBustedUrl = `${publicUrl}?v=${timestamp}`;
                const libro = catalogo.find(l => l.idRegistro === idLibro);
                if (libro) {
                    if (!libro.portadas) libro.portadas = [];
                    if (!libro.portadas.includes(cacheBustedUrl)) {
                        libro.portadas.push(cacheBustedUrl);
                    }
                }
                const portadasGuardadas = JSON.parse(localStorage.getItem('portadas_libros') || '{}');
                if (!portadasGuardadas[idLibro]) portadasGuardadas[idLibro] = [];
                if (!portadasGuardadas[idLibro].includes(cacheBustedUrl)) {
                    portadasGuardadas[idLibro].push(cacheBustedUrl);
                }
                localStorage.setItem('portadas_libros', JSON.stringify(portadasGuardadas));
                librosConPortadas = catalogo.map(l => ({
                    id: l.idRegistro,
                    titulo: l.titulo,
                    portadas: [...(l.portadas || []), ...(portadasGuardadas[l.idRegistro] || [])]
                })).filter(l => l.portadas.length > 0);
                renderRecomendados();
                iniciarRotativas();
                status.textContent = '¬°Portada subida exitosamente a GitHub!';
                status.style.color = 'green';
                showToast(`Portada de "${libro?.titulo || 'el libro'}" ahora disponible globalmente.`, 'success');
                setTimeout(() => {
                    cerrarModalAdmin();
                    mostrarResultadosModal();
                }, 1000);
            } catch (error) {
                console.error('Error en subida:', error);
                status.textContent = `Error: ${error.message}. Verifica el token de GitHub.`;
                status.style.color = 'red';
                showToast('Fallo en la subida. Revisa la consola para detalles.', 'error');
            }
        }
        function abrirEliminarPortada(idLibro) {
            const content = document.getElementById('adminContent');
            const libro = catalogo.find(l => l.idRegistro === idLibro);
            const portadas = libro ? libro.portadas : [];
            content.innerHTML = `
                <div class="admin-form">
                    <p><strong>Seleccionar portada a eliminar:</strong> <em>${libro?.titulo || 'Libro'}</em></p>
                    <select id="delete-cover-select">
                        ${portadas.map((portada, index) => `
                            <option value="${portada}" data-index="${index}">Portada ${index + 1}</option>
                        `).join('')}
                    </select>
                    <button class="admin-login-btn" onclick="eliminarPortada('${idLibro}')" style="background:#dc3545;">Eliminar Portada</button>
                    <button class="admin-cancel-btn" onclick="cerrarModalAdmin()">Cancelar</button>
                    <p id="delete-status" style="margin-top:8px; font-size:0.9em;"></p>
                </div>
            `;
            document.getElementById('adminModal').style.display = 'block';
            setupFocusTrap('adminModal');
        }
        async function eliminarPortada(idLibro) {
            const token = localStorage.getItem('githubToken');
            if (!token) {
                showToast('Token de GitHub no encontrado. Inicia sesi√≥n nuevamente.', 'error');
                return;
            }
            const select = document.getElementById('delete-cover-select');
            const status = document.getElementById('delete-status');
            const portadaUrl = select.value;
            if (!portadaUrl) {
                status.textContent = 'Selecciona una portada para eliminar.';
                status.style.color = 'red';
                return;
            }
            status.textContent = 'Eliminando portada...';
            status.style.color = 'blue';
            try {
                const fileName = portadaUrl.split('/').pop().split('?')[0];
                const deleteUrl = `${CONFIG.GITHUB_API_URL}${fileName}`;
                const getResponse = await fetch(deleteUrl, {
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                if (!getResponse.ok) throw new Error('No se encontr√≥ el archivo en GitHub.');
                const fileData = await getResponse.json();
                const sha = fileData.sha;
                const deleteResponse = await fetch(deleteUrl, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `token ${token}`,
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: `Eliminar portada para libro ${idLibro}`,
                        sha
                    })
                });
                if (!deleteResponse.ok) {
                    const errorData = await deleteResponse.json();
                    throw new Error(`Error GitHub: ${deleteResponse.status} - ${errorData.message || 'Desconocido'}`);
                }
                const libro = catalogo.find(l => l.idRegistro === idLibro);
                if (libro) {
                    libro.portadas = libro.portadas.filter(p => p !== portadaUrl);
                    const portadasGuardadas = JSON.parse(localStorage.getItem('portadas_libros') || '{}');
                    portadasGuardadas[idLibro] = libro.portadas;
                    localStorage.setItem('portadas_libros', JSON.stringify(portadasGuardadas));
                }
                librosConPortadas = catalogo.map(l => ({
                    id: l.idRegistro,
                    titulo: l.titulo,
                    portadas: l.portadas.filter(p => p !== portadaUrl)
                })).filter(l => l.portadas.length > 0);
                renderRecomendados();
                iniciarRotativas();
                status.textContent = '¬°Portada eliminada exitosamente!';
                status.style.color = 'green';
                showToast(`Portada eliminada de "${libro?.titulo || 'el libro'}".`, 'success');
                setTimeout(() => {
                    cerrarModalAdmin();
                    mostrarResultadosModal();
                }, 1000);
            } catch (error) {
                console.error('Error al eliminar:', error);
                status.textContent = `Error: ${error.message}`;
                status.style.color = 'red';
                showToast('Fallo al eliminar la portada. Revisa la consola.', 'error');
            }
        }
        function logoutAdmin() {
            localStorage.removeItem('adminLogged');
            localStorage.removeItem('adminLoginTime');
            localStorage.removeItem('githubToken');
            showToast('Sesi√≥n de administrador cerrada.', 'success');
            document.querySelector('.logout-btn').style.display = 'none';
            setTimeout(() => mostrarResultadosModal(), 500);
        }
        function actualizarContador() {
            const ahora = new Date();
            const manana = new Date(ahora);
            manana.setDate(manana.getDate() + 1);
            manana.setHours(0, 0, 0, 0);
            const diff = manana - ahora;
            const horas = Math.floor(diff / 3600000);
            const minutos = Math.floor((diff % 3600000) / 60000);
            const segundos = Math.floor((diff % 60000) / 1000);
            document.getElementById('contadorDia').textContent =
                `Nuevos libros en ${horas.toString().padStart(2, '0')}h ${minutos.toString().padStart(2, '0')}m ${segundos.toString().padStart(2, '0')}s`;
        }
        function precargarPortadasClave() {
            const clave = librosConPortadas.slice(0, 8);
            clave.forEach(libro => {
                if (libro.portadas.length > 0) {
                    const link = document.createElement('link');
                    link.rel = 'preload';
                    link.as = 'image';
                    link.href = libro.portadas[0];
                    link.imagesizes = '120px';
                    link.imagesrcset = `${libro.portadas[0]} 1x`;
                    document.head.appendChild(link);
                }
            });
        }
        async function getUserIP() {
            try {
                const res = await fetch('https://api.ipify.org?format=json', {
                    mode: 'cors',
                    cache: 'no-cache'
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                const ip = data.ip || 'unknown';
                console.log('IP detectada:', ip);
                return ip;
            } catch (err) {
                console.warn('getUserIP fall√≥:', err);
                const fallback = 'anon_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                console.log('Usando fallback IP:', fallback);
                return fallback;
            }
        }
        async function getVotosDiarios(ip) {
            const url = `${CONFIG.WEB_APP_URL}?action=getDailyVotes&ip=${ip}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                return data.count || 0;
            } catch (err) {
                console.error('Error contando votos diarios:', err);
                return 0;
            }
        }
        async function eliminarVoto(idLibro, ip) {
            const url = `${CONFIG.WEB_APP_URL}?action=deleteCalificacion&id=${idLibro}&ip=${ip}`;
            try {
                console.log('Eliminando voto ‚Üí', url);
                const res = await fetch(url, { method: 'GET' });
                if (!res.ok) {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
                const text = await res.text();
                console.log('Respuesta del servidor:', text);
                if (text.trim().startsWith('<')) {
                    throw new Error('El servidor devolvi√≥ HTML en lugar de JSON. Verifica la publicaci√≥n del Web App.');
                }
                let data;
                try {
                    data = JSON.parse(text);
                } catch (parseError) {
                    throw new Error(`Respuesta no es JSON: ${text.substring(0, 100)}`);
                }
                if (data.error) {
                    let mensajeError = data.error;
                    if (data.error.includes('Acci√≥n no v√°lida')) {
                        mensajeError = 'Error de servidor: Redeploya el Web App en GAS.';
                    } else if (data.error.includes('Faltan ID o IP')) {
                        mensajeError = 'IP no detectada. Prueba en otra red.';
                    } else if (data.error.includes('Libro no encontrado')) {
                        mensajeError = 'Voto no existe. Revota primero.';
                    }
                    showToast(mensajeError, 'warning');
                    return false;
                }
                if (data.success) {
                    showToast('Voto eliminado correctamente.', 'success');
                    return true;
                }
                showToast('Respuesta inesperada del servidor.', 'warning');
                return false;
            } catch (err) {
                console.error('Error en eliminarVoto():', err);
                showToast(`Error al eliminar: ${err.message}`, 'error');
                return false;
            }
        }
        async function cargarCalificacion(idLibro, promedioId = `promedio-${idLibro}`) {
            const url = `${CONFIG.WEB_APP_URL}?action=getCalificacion&id=${idLibro}`;
            try {
                const res = await fetch(url);
                const data = await res.json();
                const span = document.getElementById(promedioId);
                if (span) {
                    span.textContent = data.numVotos > 0
                        ? `${data.promedio.toFixed(1)} ‚òÖ (${data.numVotos} voto${data.numVotos > 1 ? 's' : ''})`
                        : 'Sin votos';
                }
                return data;
            } catch (err) {
                console.error('Error cargando calificaci√≥n:', err);
            }
        }
        async function calificarLibro(idLibro, estrellas, titulo, ip) {
            const votosHoy = await getVotosDiarios(ip);
            const LIMITE_DIARIO = 10;
            if (votosHoy >= LIMITE_DIARIO) {
                showToast(`L√≠mite diario alcanzado (${LIMITE_DIARIO} votos). Intenta ma√±ana.`, 'warning');
                return false;
            }
            const url = `${CONFIG.WEB_APP_URL}?action=setCalificacion&id=${idLibro}&estrellas=${estrellas}&titulo=${encodeURIComponent(titulo)}&ip=${ip}`;
            try {
                const res = await fetch(url, { method: 'GET' });
                const data = await res.json();
                if (data.error) {
                    showToast(data.error, 'warning');
                    return false;
                }
                showToast(`¬°Gracias! Voto de ${estrellas}‚òÖ guardado. (${votosHoy + 1}/${LIMITE_DIARIO} hoy)`, 'success');
                return true;
            } catch (err) {
                console.error('Error votando:', err);
                showToast('Error al votar. Intenta m√°s tarde.', 'error');
                return false;
            }
        }
        function showFireworks(container, fullscreen = false) {
            const fireworks = document.createElement('div');
            fireworks.className = `fireworks ${fullscreen ? 'fullscreen' : ''}`;
            fireworks.setAttribute('aria-hidden', 'true');
            if (!fullscreen) {
                container.parentElement.appendChild(fireworks);
            } else {
                document.body.appendChild(fireworks);
            }
            for (let i = 0; i < 30; i++) {
                const particle = document.createElement('div');
                particle.className = 'firework-particle';
                particle.style.left = '50%';
                particle.style.top = '50%';
                particle.style.setProperty('--dx', (Math.random() - 0.5) * (fullscreen ? 400 : 100) + 'px');
                particle.style.setProperty('--dy', (Math.random() - 0.5) * (fullscreen ? 400 : 100) + 'px');
                fireworks.appendChild(particle);
            }
            setTimeout(() => fireworks.remove(), 1200);
        }
        function showExplosion(container) {
            container.classList.add('explosion');
            container.querySelectorAll('.estrella').forEach((estrella, i) => {
                setTimeout(() => estrella.classList.add('pendiente-eliminar'), i * 50);
            });
            setTimeout(() => {
                container.classList.remove('explosion');
                container.querySelectorAll('.estrella').forEach(s => s.classList.remove('pendiente-eliminar'));
            }, 600);
        }
        function initEstrellas() {
            document.querySelectorAll('.estrellas').forEach(container => {
                const idLibro = container.dataset.id;
                const titulo = decodeURIComponent(container.dataset.titulo);
                const estrellas = container.querySelectorAll('.estrella');
                const promedioId = container.closest('#valoradosContent')
                    ? `promedio-valorados-${idLibro}`
                    : `promedio-${idLibro}`;
                cargarCalificacion(idLibro, promedioId);
                const key = `voto_${idLibro}_local`;
                let seleccionado = parseInt(localStorage.getItem(key)) || -1;
                let modoEliminar = false;
                if (seleccionado > 0) {
                    estrellas.forEach((s, i) => {
                        if (i < seleccionado) s.classList.add('seleccionada');
                    });
                }
                container.addEventListener('mousemove', (e) => {
                    if (!e.target.classList.contains('estrella')) return;
                    const val = parseInt(e.target.dataset.value);
                    estrellas.forEach((s, i) => {
                        s.classList.toggle('hover', i < val);
                    });
                });
                container.addEventListener('mouseleave', () => {
                    estrellas.forEach(s => s.classList.remove('hover'));
                });
                container.addEventListener('click', async (e) => {
                    if (!e.target.classList.contains('estrella')) return;
                    const val = parseInt(e.target.dataset.value);
                    const ip = await getUserIP();
                    if (seleccionado > 0 && modoEliminar) {
                        const success = await eliminarVoto(idLibro, ip);
                        if (success) {
                            localStorage.removeItem(key);
                            seleccionado = -1;
                            modoEliminar = false;
                            estrellas.forEach(s => {
                                s.classList.remove('seleccionada', 'pendiente-eliminar');
                            });
                            container.setAttribute('aria-valuenow', 0);
                            container.setAttribute('aria-label', `Calificaci√≥n actual: 0 de 5 estrellas para ${titulo}`);
                            cargarCalificacion(idLibro, promedioId);
                            showExplosion(container);
                        } else {
                            modoEliminar = false;
                            estrellas.forEach((s, i) => {
                                s.classList.toggle('pendiente-eliminar', i < seleccionado);
                                s.classList.toggle('seleccionada', i < seleccionado);
                            });
                            showToast('No se pudo eliminar el voto.', 'error');
                        }
                        return;
                    }
                    if (seleccionado > 0) {
                        modoEliminar = true;
                        estrellas.forEach((s, i) => {
                            if (i < seleccionado) {
                                s.classList.remove('seleccionada');
                                s.classList.add('pendiente-eliminar');
                            } else {
                                s.classList.remove('pendiente-eliminar');
                            }
                        });
                        container.setAttribute('aria-label', `Confirmar eliminaci√≥n de ${seleccionado} estrellas para ${titulo}`);
                        showToast('Haz clic de nuevo para confirmar eliminaci√≥n', 'warning');
                        return;
                    }
                    const votosHoy = await getVotosDiarios(ip);
                    if (votosHoy >= 10) {
                        showToast(`L√≠mite diario alcanzado (10 votos). Intenta ma√±ana.`, 'warning');
                        return;
                    }
                    const success = await calificarLibro(idLibro, val, titulo, ip);
                    if (success) {
                        localStorage.setItem(key, val);
                        seleccionado = val;
                        modoEliminar = false;
                        estrellas.forEach((s, i) => {
                            s.classList.toggle('seleccionada', i < val);
                            s.classList.remove('pendiente-eliminar');
                        });
                        container.setAttribute('aria-valuenow', val);
                        container.setAttribute('aria-label', `Calificaci√≥n actual: ${val} de 5 estrellas para ${titulo}`);
                        cargarCalificacion(idLibro, promedioId);
                        showFireworks(container, true);
                    }
                });
            });
        }
        function renderRecomendados() {
            const ahora = new Date();
            const a√±oMesDia = `${ahora.getFullYear()}-${String(ahora.getMonth() + 1).padStart(2, '0')}-${String(ahora.getDate()).padStart(2, '0')}`;
            const claveCache = `recomendados_${a√±oMesDia}`;
            const cache = JSON.parse(localStorage.getItem(claveCache) || 'null');
            const diaMes = String(ahora.getDate()).padStart(2, '0');
            const mesNum = String(ahora.getMonth() + 1).padStart(2, '0');
            const a√±o = ahora.getFullYear();
            document.getElementById('tituloRecomendados').textContent = `Libros destacados de ${diaMes}/${mesNum}/${a√±o}üê±‚Äçüëì`;
            const conPortadas = librosConPortadas.filter(l => l.portadas.length > 0);
            if (conPortadas.length === 0) {
                document.getElementById('recomendadosGrid').innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No hay portadas disponibles hoy.</p>';
                return;
            }
            let seleccionados = [];
            if (cache && cache.libros && cache.fecha === a√±oMesDia) {
                seleccionados = cache.libros.map(id =>
                    conPortadas.find(l => l.id === id)
                ).filter(Boolean);
            }
            if (seleccionados.length < 5) {
                const seed = parseInt(a√±oMesDia.replace(/-/g, ''), 10);
                const seededRandom = (function(s) {
                    let state = s;
                    return function() {
                        state = (state * 1664525 + 1013904223) % 2147483647;
                        return state / 2147483647;
                    };
                })(seed);
                const shuffled = [...conPortadas].sort(() => seededRandom() - 0.5);
                seleccionados = shuffled.slice(0, 5);
                localStorage.setItem(claveCache, JSON.stringify({
                    fecha: a√±oMesDia,
                    libros: seleccionados.map(l => l.id)
                }));
            }
            const grid = document.getElementById('recomendadosGrid');
            grid.innerHTML = seleccionados.map(libro => `
                <img src="${libro.portadas[0]}" alt="Portada de ${libro.titulo}"
                     data-id="${libro.id}" onclick="openSearchForBook('${libro.id}')"
                     loading="lazy" onerror="this.src='${CONFIG.DEFAULT_PORTADA}'">
            `).join('');
        }
        function iniciarRotativas() {
            const conPortadas = librosConPortadas.filter(l => l.portadas.length > 0);
            if (conPortadas.length === 0) {
                document.getElementById('rotativasContainer').innerHTML = '<p style="text-align: center; color: var(--text-secondary);">No hay portadas para rotar.</p>';
                return;
            }
            const container = document.getElementById('rotativasContainer');
            container.innerHTML = '';
            conPortadas.forEach((libro, index) => {
                const total = conPortadas.length;
                const img = document.createElement('img');
                img.src = libro.portadas[0];
                img.alt = `Portada de ${libro.titulo}`;
                img.setAttribute('aria-label', `Portada rotativa ${index + 1} de ${total}: ${libro.titulo}`);
                img.setAttribute('role', 'img');
                img.dataset.id = libro.id;
                img.className = index === 0 ? 'active' : '';
                img.loading = 'lazy';
                img.onerror = () => { img.src = CONFIG.DEFAULT_PORTADA; };
                img.onclick = () => openSearchForBook(libro.id);
                container.appendChild(img);
            });
            currentRotativaIndex = 0;
            rotativasInterval = setInterval(() => {
                const imgs = container.querySelectorAll('img');
                imgs[currentRotativaIndex].classList.remove('active');
                currentRotativaIndex = (currentRotativaIndex + 1) % imgs.length;
                imgs[currentRotativaIndex].classList.add('active');
            }, 4000);
        }
        function detenerRotativas() {
            if (rotativasInterval) {
                clearInterval(rotativasInterval);
                rotativasInterval = null;
            }
        }
        function openSearchForBook(idLibro) {
            const libro = catalogo.find(l => l.idRegistro === idLibro);
            if (libro) {
                searchQuery = libro.titulo;
                searchResults = buscarLibros(searchQuery);
                currentPageSearch = 1;
                abrirModal();
                mostrarResultadosModal();
            } else {
                showToast('Libro no encontrado en el cat√°logo.', 'warning');
            }
        }
        function extraerLibroDeConsulta(query) {
            const lowerQuery = normalizarTexto(query);
            const match = lowerQuery.match(/(?:de|sobre)\s+(.+)$/i);
            if (match && match[1]) {
                return match[1].trim();
            }
            return lowerQuery.replace(/(cuantos|ejemplares|copias|disponibles|libros)/gi, '').trim();
        }
        function abrirBuscadorLibro(libro) {
            searchQuery = libro;
            searchResults = buscarLibros(libro);
            currentPageSearch = 1;
            abrirModal();
            mostrarResultadosModal();
        }
        async function initApp() {
            const MIN_SPLASH_DURATION = 2000;
            const startTime = Date.now();
            loadTheme();
            try {
                await cargarCatalogo(CONFIG.RETRY_MAX);
                await cargarPortadasDesdeGitHub();
                const hoy = new Date().toISOString().split('T')[0];
                Object.keys(localStorage).forEach(key => {
                    if (key.startsWith('recomendados_') && key !== `recomendados_${hoy}`) {
                        localStorage.removeItem(key);
                    }
                });
                renderRecomendados();
                iniciarRotativas();
                precargarPortadasClave();
                actualizarContador();
                setInterval(actualizarContador, 1000);
                const ahora = new Date();
                const manana = new Date(ahora);
                manana.setDate(manana.getDate() + 1);
                manana.setHours(0, 0, 0, 0);
                const tiempoHastaMedianoche = manana - ahora;
                setTimeout(async () => {
                    await cargarCatalogo(CONFIG.RETRY_MAX);
                    await cargarPortadasDesdeGitHub();
                    renderRecomendados();
                    iniciarRotativas();
                    showToast('¬°Nuevos libros destacados de hoy!', 'success');
                }, tiempoHastaMedianoche);
            } catch (error) {
                console.error('Error en initApp:', error);
                showToast('Error al cargar la aplicaci√≥n.', 'error');
            }
            const elapsedTime = Date.now() - startTime;
            const remainingTime = MIN_SPLASH_DURATION - elapsedTime;
            if (remainingTime > 0) {
                await new Promise(resolve => setTimeout(resolve, remainingTime));
            }
            const splash = document.getElementById('splash');
            splash.classList.add('hidden');
            document.getElementById('app').style.display = 'block';
            document.getElementById('seccionIzquierda').style.display = 'block';
            document.getElementById('chatSection').style.display = 'block';
            document.getElementById('seccionDerecha').style.display = 'none';
            setTimeout(() => splash.remove(), 500);
            loadDaltonismMode();
            loadSizeCSS();
            const isAdminLogged = localStorage.getItem('adminLogged') === 'true';
            const loginTime = localStorage.getItem('adminLoginTime');
            const LOGIN_DURATION = 24 * 60 * 60 * 1000;
            if (isAdminLogged && loginTime && (Date.now() - parseInt(loginTime) < LOGIN_DURATION)) {
                document.querySelector('.logout-btn').style.display = 'inline-block';
            } else {
                localStorage.removeItem('adminLogged');
                localStorage.removeItem('adminLoginTime');
                localStorage.removeItem('githubToken');
            }
            const portadasGuardadas = JSON.parse(localStorage.getItem('portadas_libros') || '{}');
            Object.keys(portadasGuardadas).forEach(id => {
                if (!catalogo.find(l => l.idRegistro === id)) {
                    delete portadasGuardadas[id];
                }
            });
            localStorage.setItem('portadas_libros', JSON.stringify(portadasGuardadas));
            agregarMensaje('Libros, autores, sinopsis, res√∫menes... Mi magia es poderosa, pregunta. üìñ');
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (document.getElementById('searchModal').style.display === 'block') cerrarModal();
                    if (document.getElementById('adminModal').style.display === 'block') cerrarModalAdmin();
                    if (document.getElementById('favoritosModal').style.display === 'block') cerrarModalFavoritos();
                    if (document.getElementById('valoradosModal').style.display === 'block') cerrarModalValorados();
                    if (document.getElementById('accessibilityModal').style.display === 'block') cerrarModalAccesibilidad();
                }
            });
            document.getElementById('main-content').focus();
            window.addEventListener('beforeunload', detenerRotativas);
        }
        initApp();
    </script>
</body>
</html>