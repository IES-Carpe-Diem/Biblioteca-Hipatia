<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IES CARPE DIEM - Biblioteca Hipatia</title>
    <link rel="icon" href="https://site.educa.madrid.org/ies.carpediem.fuenlabrada//wp-content/uploads/ies.carpediem.fuenlabrada/2023/03/logo-carpe-diem-cuadrado-500x500-blanco-100x100.png" sizes="32x32" />
    <link rel="icon" href="https://site.educa.madrid.org/ies.carpediem.fuenlabrada//wp-content/uploads/ies.carpediem.fuenlabrada/2023/03/logo-carpe-diem-cuadrado-500x500-blanco-300x300.png" sizes="192x192" />
    <link rel="apple-touch-icon" href="https://site.educa.madrid.org/ies.carpediem.fuenlabrada//wp-content/uploads/ies.carpediem.fuenlabrada/2023/03/logo-carpe-diem-cuadrado-500x500-blanco-300x300.png" />
    <meta name="msapplication-TileImage" content="https://site.educa.madrid.org/ies.carpediem.fuenlabrada//wp-content/uploads/ies.carpediem.fuenlabrada/2023/03/logo-carpe-diem-cuadrado-500x500-blanco-300x300.png" />
    <link rel="preload" href="./Ejemplares.xml" as="fetch" crossorigin="anonymous">
    <link rel="preload" href="https://raw.githubusercontent.com/Kelonio-hub/prueba/main/logo%20biblioteca.png" as="image">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.10/purify.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/4.0.18/marked.min.js"></script>
    <style>
        :root {
            --bg-primary: #f4f4f4;
            --bg-secondary: white;
            --text-primary: #333;
            --text-secondary: #666;
            --border-color: #ddd;
            --btn-primary: #1a73e8;
            --btn-hover: #1a73e8;
            --btn-reserva: #2a2a2a;
            --btn-reserva-hover: #2a2a2a;
            --btn-solicitud: #2a2a2a;
            --btn-solicitud-hover: #2a2a2a;
            --btn-donaciones: #2a2a2a;
            --btn-donaciones-hover: #2a2a2a;
            --btn-reseña: #2a2a2a;
            --btn-reseña-hover: #2a2a2a;
            --btn-favoritos: #2a2a2a;
            --btn-favoritos-hover: #2a2a2a;
            --shadow: 0 2px 5px rgba(0,0,0,0.1);
            --chat-bg: #f9f9f9;
            --user-msg-bg: #c9c9c9;
            --bot-msg-bg: #c9c9c9;
            --bot-msg-color: #000000;
            --splash-bg: linear-gradient(135deg, rgb(255, 255, 255) 0%, #c8c8c8 50%, #ffffff 100%);
            --splash-text: rgb(0, 0, 0);
            --splash-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
            --btn-proseguir: #17a2b8;
            --btn-proseguir-hover: #138496;
            --btn-buscar-libro: #3399ff;
            --btn-buscar-libro-hover: #1a73e8;
            --btn-sinopsis: #28a745;
            --btn-sinopsis-hover: #218838;
        }
        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #ffffff;
            --text-secondary: #ffffff;
            --border-color: #666;
            --btn-primary: #1a73e8;
            --btn-hover: #1a73e8;
            --btn-reserva: #2a2a2a;
            --btn-reserva-hover: #2a2a2a;
            --btn-solicitud: #2a2a2a;
            --btn-solicitud-hover: #2a2a2a;
            --btn-donaciones: #2a2a2a;
            --btn-donaciones-hover: #2a2a2a;
            --btn-reseña: #2a2a2a;
            --btn-reseña-hover: #2a2a2a;
            --btn-favoritos: #2a2a2a;
            --btn-favoritos-hover: #2a2a2a;
            --shadow: 0 2px 5px rgba(0,0,0,0.3);
            --chat-bg: #374151;
            --user-msg-bg: #3a3a3a;
            --bot-msg-bg: #3a3a3a;
            --bot-msg-color: #e0e0e0;
            --splash-bg: linear-gradient(135deg, #374151 0%, #374151 50%, #374151 100%);
            --splash-text: rgb(255, 255, 255);
            --splash-shadow: 2px 2px 4px rgba(255, 255, 255, 0.2);
            --btn-proseguir: #17a2b8;
            --btn-proseguir-hover: #138496;
            --btn-buscar-libro: #1a73e8;
            --btn-buscar-libro-hover: #1a73e8;
            --btn-sinopsis: #28a745;
            --btn-sinopsis-hover: #218838;
        }

        /* === MODOS DALTONISMO === */
        [data-daltonism="normal"] { filter: none; }
        [data-daltonism="deuteranomaly"] { 
            filter: brightness(1.1) contrast(1.2) hue-rotate(30deg); 
        }
        [data-daltonism="protanomaly"] { 
            filter: brightness(1.1) contrast(1.2) sepia(0.3) hue-rotate(-30deg); 
        }
        [data-daltonism="tritanomaly"] { 
            filter: brightness(1.15) contrast(1.3) hue-rotate(180deg) saturate(1.4); 
        }

        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }
        #splash {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: var(--splash-bg);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.5s ease-out;
            color: var(--splash-text);
            font-family: 'Arial', sans-serif;
            text-align: center;
            overflow: hidden;
            text-shadow: var(--splash-shadow);
            filter: inherit;
        }
        #splash.hidden { opacity: 0; pointer-events: none; }

        .splash-container {
            animation: fadeInContainer 1.5s ease-out;
        }
        #splash img {
            max-width: 250px;
            height: auto;
            margin-bottom: 20px;
            border-radius: 12px;
            animation: bounceIn 1.2s cubic-bezier(0.68, -0.55, 0.265, 1.55) 0.5s both;
            transition: transform 0.3s ease;
        }
        #splash img:hover {
            transform: scale(1.05);
        }
        #splash h2 {
            font-size: 2.8rem;
            margin: 15px 0;
            font-weight: bold;
            animation: fadeInUp 0.8s ease-out 1s both;
            letter-spacing: 1px;
        }
        #splash p {
            font-size: 1.3rem;
            opacity: 0.95;
            margin-bottom: 20px;
            animation: fadeInUp 0.8s ease-out 1.2s both;
        }
        @keyframes fadeInContainer {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        @keyframes bounceIn {
            0% { opacity: 0; transform: scale(0.3); }
            50% { opacity: 1; transform: scale(1.05); }
            70% { transform: scale(0.9); }
            100% { opacity: 1; transform: scale(1); }
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }
        #app {
            display: none;
        }
        header {
            text-align: center;
            background-image: url('https://site.educa.madrid.org/ies.carpediem.fuenlabrada//wp-content/uploads/ies.carpediem.fuenlabrada/2024/03/carpediem-foto-inicio1920x1200c.jpg');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
            position: relative;
        }
        .theme-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            gap: 5px;
            z-index: 1100;
        }
        .theme-controls.active {
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.8);
        }
        .theme-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 1.2em;
        }
        .theme-toggle:hover {
            background: rgba(255,255,255,0.3);
        }
        [data-theme="dark"] .theme-toggle {
            background: rgba(0,0,0,0.2);
        }
        [data-theme="dark"] .theme-toggle:hover {
            background: rgba(0,0,0,0.3);
        }

        .daltonism-toggle {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .daltonism-toggle:hover {
            background: rgba(255,255,255,0.35);
            transform: scale(1.1);
        }
        [data-theme="dark"] .daltonism-toggle {
            background: rgba(0,0,0,0.2);
        }
        [data-theme="dark"] .daltonism-toggle:hover {
            background: rgba(0,0,0,0.35);
        }
        .daltonism-toggle.active {
            background: rgba(255,255,255,0.4) !important;
            box-shadow: 0 0 8px rgba(255,255,255,0.6);
        }
        [data-theme="dark"] .daltonism-toggle.active {
            background: rgba(0,0,0,0.4) !important;
            box-shadow: 0 0 8px rgba(255,255,255,0.4);
        }

        .header-search {
            margin-top: 10px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        .search-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            width: 100%;
            max-width: 600px;
        }
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            width: 100%;
        }
        .header-search input {
            padding: 8px;
            border: none;
            border-radius: 4px;
            width: 250px;
            max-width: 100%;
            background: rgba(255,255,255,0.9);
        }
        .header-search button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            color: white;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        .header-search .buscar-btn {
            background-color: var(--btn-primary);
        }
        .header-search .buscar-btn:hover {
            background-color: var(--btn-hover);
        }
        .header-search .reserva-btn {
            background-color: var(--btn-reserva);
        }
        .header-search .reserva-btn:hover {
            background-color: var(--btn-reserva-hover);
        }
        .header-search .reseña-btn {
            background-color: var(--btn-reseña);
        }
        .header-search .reseña-btn:hover {
            background-color: var(--btn-reseña-hover);
        }
        .header-search .solicitud-btn {
            background-color: var(--btn-solicitud);
        }
        .header-search .solicitud-btn:hover {
            background-color: var(--btn-solicitud-hover);
        }
        .header-search .donaciones-btn {
            background-color: var(--btn-donaciones);
        }
        .header-search .donaciones-btn:hover {
            background-color: var(--btn-donaciones-hover);
        }
        .header-search .favoritos-btn {
            background-color: var(--btn-favoritos);
            font-size: 1.2em;
        }
        .header-search .favoritos-btn:hover {
            background-color: var(--btn-favoritos-hover);
        }
        main {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }
        section {
            flex: 1;
            background: var(--bg-secondary);
            padding: 20px;
            border-radius: 8px;
            box-shadow: var(--shadow);
        }
        #seccionDerecha {
            flex: 1;
            max-width: 800px;
            margin: 0 auto;
        }
        #chatMensajes {
            height: 200px;
            overflow-y: scroll;
            border: 1px solid var(--border-color);
            padding: 10px;
            margin: 10px 0;
            background-color: var(--chat-bg);
            color: var(--text-primary);
        }
        .mensaje {
            margin: 5px 0;
            padding: 5px;
            color: var(--text-primary);
            border-radius: 4px;
            position: relative;
        }
        .mensaje.user {
            background-color: var(--user-msg-bg);
            text-align: right;
        }
        .mensaje.bot {
            background-color: var(--bot-msg-bg);
            color: var(--bot-msg-color);
        }
        .mensaje.temporal {
            font-style: italic;
            color: #888;
            opacity: 0.7;
        }
        .proseguir-btn, .buscar-libro-btn, .reserva-libro-btn, .solicitud-libro-btn, .sinopsis-btn {
            border: none;
            padding: 5px 10px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 5px;
            margin-right: 5px;
            display: inline-block;
            transition: background-color 0.3s;
        }
        .proseguir-btn {
            background-color: var(--btn-proseguir);
            color: white;
        }
        .proseguir-btn:hover {
            background-color: var(--btn-proseguir-hover);
        }
        .buscar-libro-btn {
            background-color: var(--btn-buscar-libro);
            color: white;
        }
        .buscar-libro-btn:hover {
            background-color: var(--btn-buscar-libro-hover);
        }
        .reserva-libro-btn {
            background-color: var(--btn-reserva);
            color: white;
        }
        .reserva-libro-btn:hover {
            background-color: var(--btn-reserva-hover);
        }
        .solicitud-libro-btn {
            background-color: var(--btn-solicitud);
            color: white;
        }
        .solicitud-libro-btn:hover {
            background-color: var(--btn-solicitud-hover);
        }
        .sinopsis-btn {
            background-color: var(--btn-sinopsis);
            color: white;
        }
        .sinopsis-btn:hover {
            background-color: var(--btn-sinopsis-hover);
        }
        .favorito-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            cursor: pointer;
            margin-left: 5px;
            transition: transform 0.2s;
        }
        .favorito-btn:hover {
            transform: scale(1.1);
        }
        .favorito-btn.active {
            color: #ff0000;
        }
        .chat-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .chat-controls input {
            flex: 1;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .chat-controls input::placeholder {
            color: var(--text-secondary);
            opacity: 0.7;
        }
        .chat-controls button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: var(--btn-primary);
            color: white;
            cursor: pointer;
        }
        .chat-controls button:hover {
            background-color: var(--btn-hover);
        }
        #searchModal, #adminModal, #favoritosModal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            pointer-events: none;
        }
        #searchModalContent, #adminModalContent, #favoritosModalContent {
            background-color: var(--bg-secondary);
            margin: 5% auto;
            padding: 20px;
            border: none;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow);
            color: var(--text-primary);
            box-sizing: border-box;
            position: relative;
            pointer-events: auto;
        }
        .modal-close {
            color: var(--text-secondary);
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            pointer-events: auto;
        }
        .modal-close:hover {
            color: var(--text-primary);
        }
        .modal-search {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
        }
        .modal-search input {
            flex: 1;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        .modal-search button {
            padding: 8px 12px;
            border: none;
            border-radius: 4px;
            background-color: var(--btn-primary);
            color: white;
            cursor: pointer;
        }
        .modal-search button:hover {
            background-color: var(--btn-hover);
        }
        .libro-modal {
            border: 1px solid var(--border-color);
            padding: 0;
            margin: 10px 0;
            border-radius: 4px;
            background: var(--bg-secondary);
            overflow: hidden;
            display: flex;
            gap: 15px;
        }
        .portada-section {
            flex: 0 0 120px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .info-section {
            flex: 1;
            padding: 15px;
            line-height: 1.6;
        }
        .info-section p {
            margin: 8px 0;
        }
        .tejuelo {
            font-family: monospace;
            padding: 2px 4px;
            border-radius: 2px;
            color: black;
        }
        .tejuelo[data-categoria="narrativa"] {
            background-color: #1bd47a;
        }
        .tejuelo[data-categoria="poesía"] {
            background-color: #ff48a9;
        }
        .tejuelo[data-categoria="teatro"] {
            background-color: #e350de;
        }
        .tejuelo[data-categoria="literatura inglesa"] {
            background-color: #d4d700;
        }
        .tejuelo[data-categoria="enciclopedias"] {
            background-color: #ffaa00;
        }
        .tejuelo[data-categoria="cómic"] {
            background-color: #33c5ff;
        }
        .tejuelo[data-categoria="deportes"] {
            background-color: #ff0000;
        }
        .tejuelo:not([data-categoria]),
        .tejuelo[data-categoria="no disponible"] {
            background-color: #cccccc;
        }
        .pagination {
            text-align: center;
            margin: 10px 0;
        }
        .pagination button {
            background-color: var(--btn-primary);
            color: white;
            border: none;
            padding: 5px 10px;
            margin: 0 5px;
            cursor: pointer;
            border-radius: 4px;
        }
        .pagination button:disabled {
            background-color: var(--border-color);
            color: #ffffff;
            cursor: not-allowed;
            opacity: 0.7;
        }
        .pagination button.active {
            background-color: var(--text-secondary);
            font-weight: bold;
        }
        .pagination span {
            font-weight: bold;
        }
        #conteoResultadosModal {
            font-weight: bold;
            color: var(--btn-primary);
            margin-bottom: 10px;
            padding: 5px;
            background-color: #e9f5ff;
            border-radius: 4px;
        }
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #28a745;
            color: white;
            padding: 15px;
            border-radius: 4px;
            box-shadow: var(--shadow);
            z-index: 10000;
            min-width: 300px;
            animation: slideInRight 0.3s ease-out;
            role: alert;
        }
        .toast.error {
            background: #dc3545;
        }
        .toast.warning {
            background: #ffc107;
            color: black;
        }
        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            border: 0;
        }

        .admin-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        .admin-form input {
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
        }
        .admin-form button {
            padding: 8px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        .admin-login-btn {
            background-color: var(--btn-primary);
            color: white;
        }
        .admin-cancel-btn {
            background-color: #666;
            color: white;
        }

        @media (max-width: 768px) {
            main {
                flex-direction: column;
            }
            #seccionDerecha {
                flex: none;
                max-width: none;
            }
            #splash h2 { font-size: 2rem; }
            #splash p { font-size: 1.1rem; }
            #splash img { max-width: 180px; }
            .search-container, .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            .header-search input,
            .header-search button {
                width: 100%;
                max-width: 300px;
            }
            #searchModalContent, #adminModalContent, #favoritosModalContent {
                width: 95%;
                margin: 10% auto;
                padding: 15px;
            }
            .toast {
                bottom: 10px;
                right: 10px;
                left: 10px;
                min-width: auto;
            }
            .theme-controls {
                flex-direction: column;
                gap: 2px;
            }
            .chat-controls {
                flex-direction: column;
            }
            .libro-modal {
                flex-direction: column;
                text-align: center;
            }
            .portada-section {
                flex: none;
                margin-bottom: 10px;
            }
        }
        @media (prefers-reduced-motion: reduce) {
            #splash img, #splash h2, #splash p {
                animation: none !important;
                transition: none !important;
            }
        }

        .portada-container {
            position: relative;
            width: 120px;
            height: 180px;
            background: var(--bg-secondary);
            border-radius: 6px;
            overflow: hidden;
        }

        .portada-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #f0f0f0 0%, #e0e0e0 100%);
            border-radius: 6px;
            z-index: 1;
        }

        .portada-container::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid #ddd;
            border-top: 4px solid var(--btn-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 2;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        .portada-container img.default-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
            z-index: 3;
        }

        .portada-container.loaded::before,
        .portada-container.loaded::after {
            display: none;
        }

        .portada-slider-3d {
            width: 120px;
            height: 180px;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s ease;
            z-index: 3;
        }

        .portada-img-3d {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            backface-visibility: hidden;
            border-radius: 6px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            opacity: 0.9;
            z-index: 4;
        }

        .portada-img-3d.active {
            opacity: 1;
            transform: translateZ(60px);
            z-index: 10;
        }

        @media (prefers-reduced-motion: reduce) {
            .portada-container::after {
                animation: none;
            }
        }
    </style>
</head>
<body data-theme="light" data-daltonism="normal">
    <div id="splash" tabindex="0">
        <div class="splash-container">
            <img src="https://raw.githubusercontent.com/Kelonio-hub/prueba/main/logo%20biblioteca.png"
                alt="Logo de la Biblioteca Hipatia"
                loading="lazy"
                onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjY2NjIi8+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGZvbnQtZmFtaWx5PSJBcmlhbCIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzk5OSIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9Ii4zZW0iPkxvZ28gTm8gQ2FycmVnYWRvPC90ZXh0Pjwvc3ZnPg=='">
            <h2>¡Bienvenidos a la Biblioteca Hipatia!</h2>
            <p>Cargando el catálogo de libros y portadas...</p>
        </div>
    </div>
    <div id="app">
        <header>
            <div class="theme-controls">
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Cambiar entre tema claro y oscuro">Moon</button>
                <button class="daltonism-toggle" onclick="toggleDaltonism()" aria-label="Activar modo para daltonismo" title="Modo accesible para daltonismo">
                    <svg width="18" height="18" viewBox="0 0 100 100" fill="none" stroke="currentColor" stroke-width="10" stroke-linecap="round">
                        <circle cx="50" cy="50" r="35"/>
                        <path d="M 15 50 H 85"/>
                        <path d="M 50 15 V 85"/>
                    </svg>
                </button>
                <button class="logout-btn" onclick="logoutAdmin()" aria-label="Cerrar sesión de administrador" style="display: none;">Cerrar Sesión Lock</button>
            </div>
            <h1>Biblioteca Hipatia - <a href="https://site.educa.madrid.org/ies.carpediem.fuenlabrada/" target="_blank" style="color:#ffffff;"> IES CARPE DIEM</a></h1>
            <div class="header-search">
                <div class="search-container">
                    <input type="text" id="buscarInput" placeholder="Busca por título, autor, tejuelo, categoría" 
                        aria-label="Buscar libros por título, autor, tejuelo o categoría" 
                        aria-describedby="search-instruction" 
                        onkeypress="if(event.key === 'Enter') mostrarResultadosBusqueda()" 
                        list="sugerenciasBusqueda">                
                    <datalist id="sugerenciasBusqueda"></datalist>
                    <button class="buscar-btn" onclick="mostrarResultadosBusqueda()" aria-label="Buscar libros en el catálogo">Buscar Search</button>
                </div>
                <div class="action-buttons">
                    <button class="reserva-btn" onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSeTUAdMIEZz0lP2qflcZgfIP2zhsU4sYJoQZYoJcmvUZRAQnw/viewform?usp=header', '_blank')" 
                            aria-label="Abrir formulario de reserva de libros">Reserva de Libros Book</button>
                    <button class="reseña-btn" onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLScbwLhvODSn6s5oP_GOdVhtUtojdiDUOBe5O2pJexUW5VT-Fw/viewform?usp=header', '_blank')" 
                            aria-label="Abrir formulario de reseñas de libros">Reseña de Libros Pen</button>
                    <button class="solicitud-btn" onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSf_VH-Wmf7SC7geWNwoLhX1aqc_xy1LQ-fp-SFYdlOYIbTE-g/viewform?usp=header', '_blank')" 
                            aria-label="Abrir formulario de solicitud de libros nuevos">Solicitud de Libros Ballot</button>
                    <button class="donaciones-btn" onclick="window.open('https://forms.gle/GobAksYs7vpXY8HG6', '_blank')" 
                            aria-label="Abrir formulario de donaciones de libros">Donación de Libros Package</button>
                    <button class="favoritos-btn" onclick="abrirModalFavoritos()" aria-label="Ver libros favoritos">Heart</button>
                </div>
            </div>
            <p id="search-instruction" class="visually-hidden">Busca libros por título, autor, tejuelo o categoría en la barra de búsqueda.</p>
        </header>
        <main>
            <section id="seccionDerecha">
                <h2>Hipat-IA</h2>
                <p>¡Tu Bibliotecaria Virtual! Woman</p>
                <div id="chatMensajes" role="log" aria-live="polite"></div>
                <div class="chat-controls">
                    <input type="text" id="chatInput" placeholder="Libros, sinopsis, recomendaciones..." 
                        aria-label="Enviar mensaje a la bibliotecaria virtual" 
                        aria-describedby="chat-instruction" 
                        onkeypress="if(event.key === 'Enter') enviarMensaje()">                    
                    <button onclick="enviarMensaje()" aria-label="Enviar mensaje al chatbot">Enviar Chat</button>
                </div>
                <p id="chat-instruction" class="visually-hidden">Envía un mensaje a la bibliotecaria virtual para obtener ayuda con libros o recomendaciones.</p>
            </section>
        </main>
        <div id="searchModal" tabindex="0">
            <div id="searchModalContent">
                <span class="modal-close" role="button" aria-label="Cerrar ventana de resultados de búsqueda" onclick="cerrarModal()">×</span>
                <h3>Resultados de Búsqueda</h3>
                <div class="modal-search">
                    <input type="text" id="modalSearchInput" placeholder="Busca por título, autor, tejuelo, categoría" 
                        aria-label="Buscar libros en el modal por título, autor, tejuelo o categoría" 
                        onkeypress="if(event.key === 'Enter') buscarEnModal()">
                    <button onclick="buscarEnModal()" aria-label="Buscar libros en el catálogo">Buscar Search</button>
                </div>
                <div id="conteoResultadosModal"></div>
                <div id="resultadosModal"></div>
                <div id="searchPagination" class="pagination"></div>
            </div>
        </div>
        <div id="adminModal">
            <div id="adminModalContent">
                <span class="modal-close" onclick="cerrarModalAdmin()">×</span>
                <h3>Panel de Administrador</h3>
                <div id="adminContent"></div>
            </div>
        </div>
        <div id="favoritosModal">
            <div id="favoritosModalContent">
                <span class="modal-close" onclick="cerrarModalFavoritos()">×</span>
                <h3>Mis Libros Favoritos</h3>
                <div id="favoritosContent"></div>
            </div>
        </div>
    </div>
    <script>
        let catalogo = [];
        let searchResults = [];
        let searchQuery = '';
        let currentPageSearch = 1;
        let toastCount = 0;
        let respuestasPendientes = {};
        let mensajeActualId = 0;
        let historialMensajes = [];
        let cacheRespuestas = JSON.parse(localStorage.getItem('hipatia_cache')) || {};
        let favoritos = JSON.parse(localStorage.getItem('libros_favoritos')) || [];
        let librosConPortadas = [];

        const ADMIN_USER = "admin";
        const ADMIN_PASS = "hipatia2025";

        const API_KEY = 'AIzaSyCls5FtXaTdzQfM5FarqmHSALeGmnIPcAg';
        const BASE_URL = 'https://generativelanguage.googleapis.com/v1beta/models/';
        const MODELOS_A_PROBAR = [
            'gemini-2.5-flash',
            'gemini-2.5-pro',
            'gemini-2.0-flash',
            'gemini-1.5-flash-latest',
            'gemini-1.5-pro-latest'
        ];
        let MODELO_FUNCIONAL = localStorage.getItem('gemini_modelo_funcional') || null;

        const GITHUB_API_URL = 'https://api.github.com/repos/IES-Carpe-Diem/Biblioteca-Hipatia/contents/portadas/';
        const BASE_PORTADAS = window.location.origin + '/portadas/';
        const CDN_PORTADAS = 'https://cdn.jsdelivr.net/gh/IES-Carpe-Diem/Biblioteca-Hipatia@main/portadas/';
        const DEFAULT_PORTADA = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTIwIiBoZWlnaHQ9IjE4MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cmVjdCB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiBmaWxsPSIjZGRkIiBzdHJva2U9IiNhYWEiIHN0cm9rZS13aWR0aD0iMiIvPjx0ZXh0IHg9IjUwJSIgeT0iNTAlIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5Qb3J0YWRhIG5vIGRpc3BvbmlibGU8L3RleHQ+PC9zdmc+';

        function sanitizeHTML(str) {
            return DOMPurify.sanitize(str);
        }

        function showToast(message, type = 'success') {
            const toastContainer = document.createElement('div');
            toastContainer.className = `toast ${type}`;
            toastContainer.style.position = 'fixed';
            toastContainer.style.bottom = `${20 + (toastCount * 60)}px`;
            toastContainer.style.right = '20px';
            toastContainer.style.padding = '15px';
            toastContainer.style.borderRadius = '4px';
            toastContainer.style.boxShadow = 'var(--shadow)';
            toastContainer.style.zIndex = 10000 + toastCount;
            toastContainer.style.minWidth = '300px';
            toastContainer.style.animation = 'slideInRight 0.3s ease-out';
            toastContainer.setAttribute('role', 'alert');
            toastContainer.textContent = message;
            document.body.appendChild(toastContainer);
            toastCount++;
            setTimeout(() => {
                toastContainer.remove();
                toastCount--;
            }, 3000);
        }

        function toggleTheme() {
            const body = document.body;
            const isDark = body.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            body.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            const themeBtn = document.querySelector('.theme-toggle');
            themeBtn.textContent = newTheme === 'dark' ? 'Sun' : 'Moon';
            showToast(newTheme === 'dark' ? 'Modo oscuro activado' : 'Modo claro activado', 'success');
        }

        function loadTheme() {
            const saved = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const defaultTheme = saved || (prefersDark ? 'dark' : 'light');
            document.body.setAttribute('data-theme', defaultTheme);
            const themeBtn = document.querySelector('.theme-toggle');
            themeBtn.textContent = defaultTheme === 'dark' ? 'Sun' : 'Moon';
        }

        function toggleDaltonism() {
            const body = document.body;
            const current = body.getAttribute('data-daltonism') || 'normal';
            let newMode = 'normal';
            if (current === 'normal') newMode = 'deuteranomaly';
            else if (current === 'deuteranomaly') newMode = 'protanomaly';
            else if (current === 'protanomaly') newMode = 'tritanomaly';
            else if (current === 'tritanomaly') newMode = 'normal';

            body.setAttribute('data-daltonism', newMode);
            localStorage.setItem('daltonism-mode', newMode);

            const btn = document.querySelector('.daltonism-toggle');
            btn.classList.toggle('active', newMode !== 'normal');

            const labels = {
                normal: 'Modo normal',
                deuteranomaly: 'Deuteranomalía (verde-rojo)',
                protanomaly: 'Protanomalía (rojo-verde)',
                tritanomaly: 'Tritanomalía (azul-amarillo)'
            };
            showToast(`Daltonismo: ${labels[newMode]}`, 'success');
        }

        function loadDaltonismMode() {
            const saved = localStorage.getItem('daltonism-mode') || 'normal';
            document.body.setAttribute('data-daltonism', saved);
            if (saved !== 'normal') {
                document.querySelector('.daltonism-toggle').classList.add('active');
            }
        }

        function cerrarModal() {
            document.getElementById('searchModal').style.display = 'none';
            document.getElementById('buscarInput').focus();
            document.getElementById('modalSearchInput').value = '';
            document.querySelector('.theme-controls').classList.remove('active');
        }

        function cerrarModalAdmin() {
            document.getElementById('adminModal').style.display = 'none';
            document.getElementById('adminContent').innerHTML = '';
        }

        function cerrarModalFavoritos() {
            document.getElementById('favoritosModal').style.display = 'none';
        }

        async function cargarCatalogo() {
            try {
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000);
                const cacheVersion = 'catalog-v1';
                const cachedCatalogo = localStorage.getItem('catalogo');
                const cachedVersion = localStorage.getItem('catalogoVersion');
                const cachedTimestamp = localStorage.getItem('catalogoTimestamp');
                const CACHE_DURATION = 24 * 60 * 60 * 1000;

                if (cachedCatalogo && cachedVersion === cacheVersion && cachedTimestamp) {
                    const timestamp = parseInt(cachedTimestamp, 10);
                    if (Date.now() - timestamp < CACHE_DURATION) {
                        catalogo = JSON.parse(cachedCatalogo);
                        actualizarSugerenciasBusqueda();
                        return;
                    }
                }
                const response = await fetch('./Ejemplares.xml', { signal: controller.signal });
                clearTimeout(timeoutId);
                if (!response.ok) throw new Error(`Error HTTP: ${response.status}`);
                const xmlText = await response.text();
                const parser = new DOMParser();
                const xmlDoc = parser.parseFromString(xmlText, 'text/xml');
                if (xmlDoc.getElementsByTagName('parsererror').length > 0) {
                    throw new Error('Error al parsear XML.');
                }
                const libros = {};
                Array.from(xmlDoc.getElementsByTagName('Libro')).forEach(libro => {
                    const idDocumento = libro.getAttribute('id_documento') || '';
                    const descriptor = libro.getElementsByTagName('Descriptor')[0];
                    const rawCategoria = descriptor ? descriptor.textContent : 'No disponible';
                    const categoriaMap = {
                        'narrativa': 'Narrativa',
                        'poesia': 'Poesía',
                        'poesía': 'Poesía',
                        'teatro': 'Teatro',
                        'literatura inglesa': 'Literatura inglesa',
                        'enciclopedias': 'Enciclopedias',
                        'comic': 'Cómic',
                        'cómic': 'Cómic',
                        'deportes': 'Deportes'
                    };
                    const categoria = categoriaMap[rawCategoria.toLowerCase()] || rawCategoria;
                    libros[idDocumento] = {
                        titulo: libro.getElementsByTagName('Titulo')[0]?.textContent || 'Sin título',
                        autor: libro.getElementsByTagName('Autor')[0]?.textContent || 'Desconocido',
                        categoria: categoria,
                        fechaEdicion: libro.getElementsByTagName('FechaEdicion')[0]?.textContent || 'No disponible'
                    };
                });

                const librosAgrupados = {};
                Array.from(xmlDoc.getElementsByTagName('Ejemplar')).forEach(ejemplar => {
                    const idRegistro = ejemplar.getAttribute('IdRegistro') || '';
                    const libro = libros[idRegistro] || {};
                    let signatura1 = ejemplar.getAttribute('Signatura1') || '';
                    const signaturaMap = {
                        'Narrativa': 'N',
                        'Poesía': 'P',
                        'Teatro': 'T',
                        'Literatura inglesa': 'LI',
                        'Enciclopedias': 'E',
                        'Cómic': 'C',
                        'Deportes': 'D'
                    };
                    signatura1 = signaturaMap[libro.categoria] || signatura1 || '';
                    const signatura = `${signatura1}-${ejemplar.getAttribute('Signatura2') || ''}-${ejemplar.getAttribute('Signatura3') || ''}`.trim();
                    
                    const tituloNormalizado = normalizarTexto(libro.titulo || 'Sin título').replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_-]/g, '');
                    
                    if (!librosAgrupados[idRegistro]) {
                        librosAgrupados[idRegistro] = {
                            titulo: libro.titulo || 'Sin título',
                            autor: libro.autor || 'Desconocido',
                            categoria: libro.categoria || 'No disponible',
                            fechaEdicion: libro.fechaEdicion || 'No disponible',
                            signatura: signatura || 'No disponible',
                            isbn: ejemplar.getAttribute('ISBN') || 'No disponible',
                            fecha: ejemplar.getAttribute('Fecha') || 'No disponible',
                            copiasTotales: 0,
                            copiasDisponibles: 0,
                            idRegistro: idRegistro,
                            portadas: []
                        };
                    }
                    librosAgrupados[idRegistro].copiasTotales += 1;
                    if (ejemplar.getAttribute('Estado') === '0') {
                        librosAgrupados[idRegistro].copiasDisponibles += 1;
                    }
                });
                catalogo = Object.values(librosAgrupados);
                localStorage.setItem('catalogo', JSON.stringify(catalogo));
                localStorage.setItem('catalogoVersion', cacheVersion);
                localStorage.setItem('catalogoTimestamp', Date.now());
                actualizarSugerenciasBusqueda();
            } catch (error) {
                console.error('Error al cargar:', error);
                catalogo = [];
                showToast('Catálogo en Mantenimiento, discupe las molestias.', 'error');
            }
        }

        // === NUEVA FUNCIÓN: CARGAR TODAS LAS PORTADAS DE GITHUB SIN RESTRICCIÓN DE NOMBRE ===
        async function cargarPortadasDesdeGitHub() {
            const progressEl = document.getElementById('splash').querySelector('p');
            progressEl.textContent = 'Leyendo portadas desde GitHub...';

            try {
                const response = await fetch(GITHUB_API_URL, {
                    headers: { 'Accept': 'application/vnd.github.v3+json' }
                });
                if (!response.ok) throw new Error(`GitHub API error: ${response.status}`);

                const files = await response.json();
                const portadasGuardadas = JSON.parse(localStorage.getItem('portadas_libros') || '{}');
                let totalProcesadas = 0;

                for (const file of files) {
                    if (file.name.match(/\.(jpe?g|png)$/i)) {
                        const cdnUrl = `${CDN_PORTADAS}${encodeURIComponent(file.name)}`;
                        const tituloNormalizado = file.name.replace(/\.[^.]+$/, '').replace(/[_-]/g, ' ').trim();

                        // Buscar libro por título aproximado (insensible a acentos, espacios, guiones)
                        const libroMatch = catalogo.find(l => 
                            normalizarTexto(l.titulo).includes(normalizarTexto(tituloNormalizado)) ||
                            normalizarTexto(tituloNormalizado).includes(normalizarTexto(l.titulo))
                        );

                        if (libroMatch) {
                            if (!portadasGuardadas[libroMatch.idRegistro]) portadasGuardadas[libroMatch.idRegistro] = [];
                            if (!portadasGuardadas[libroMatch.idRegistro].includes(cdnUrl)) {
                                portadasGuardadas[libroMatch.idRegistro].push(cdnUrl);
                                if (!libroMatch.portadas.includes(cdnUrl)) {
                                    libroMatch.portadas.push(cdnUrl);
                                }
                            }
                        }
                        totalProcesadas++;
                        if (totalProcesadas % 50 === 0) {
                            progressEl.textContent = `Procesadas ${totalProcesadas} portadas...`;
                        }
                    }
                }

                localStorage.setItem('portadas_libros', JSON.stringify(portadasGuardadas));
                librosConPortadas = catalogo.map(libro => ({
                    id: libro.idRegistro,
                    titulo: libro.titulo,
                    portadas: libro.portadas
                })).filter(l => l.portadas.length > 0);

                progressEl.textContent = `¡${totalProcesadas} portadas asociadas! Preparando precarga...`;
                console.log(`Portadas asociadas: ${totalProcesadas}, libros con portada: ${librosConPortadas.length}`);
            } catch (error) {
                console.warn('Error cargando portadas desde GitHub:', error);
                progressEl.textContent = 'Error al cargar portadas. Continuando...';
            }
        }

        async function precargarPortadasAgresivo() {
            const progressEl = document.getElementById('splash').querySelector('p');
            const total = Math.min(librosConPortadas.length, 50);
            let loaded = 0;

            const cacheKey = 'portadas_cache';
            const cached = localStorage.getItem(cacheKey);
            if (cached) {
                const { timestamp, portadas } = JSON.parse(cached);
                if (Date.now() - timestamp < 24 * 60 * 60 * 1000) {
                    librosConPortadas = portadas;
                    progressEl.textContent = 'Caché fresco - Cargando app...';
                    return true;
                }
            }

            progressEl.textContent = `Precargando ${total} portadas... (0/${total})`;

            const promises = librosConPortadas.slice(0, total).map(async (libro, index) => {
                try {
                    const img = new Image();
                    img.src = libro.portadas[0];
                    await new Promise((resolve) => {
                        img.onload = () => { loaded++; progressEl.textContent = `Precargando ${total} portadas... (${loaded}/${total})`; resolve(); };
                        img.onerror = () => { loaded++; progressEl.textContent = `Precargando ${total} portadas... (${loaded}/${total})`; resolve(); };
                    });
                    return { success: true };
                } catch {
                    loaded++;
                    progressEl.textContent = `Precargando ${total} portadas... (${loaded}/${total})`;
                    return { success: false };
                }
            });

            await Promise.all(promises);

            localStorage.setItem(cacheKey, JSON.stringify({
                timestamp: Date.now(),
                portadas: librosConPortadas
            }));

            progressEl.textContent = '¡Portadas listas! Bienvenido.';
            return true;
        }

        function normalizarTexto(texto) {
            if (!texto) return '';
            const acentos = { 'á': 'a', 'é': 'e', 'í': 'i', 'ó': 'o', 'ú': 'u', 'Á': 'A', 'É': 'E', 'Í': 'I', 'Ó': 'O', 'Ú': 'U' };
            return texto
                .replace(/[áéíóúÁÉÍÓÚ]/g, match => acentos[match] || match)
                .toLowerCase()
                .replace(/[^a-z0-9\s]/g, '')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function actualizarSugerenciasBusqueda() {
            const datalist = document.getElementById('sugerenciasBusqueda');
            datalist.innerHTML = catalogo.map(libro => `
                <option value="${libro.titulo}">${libro.autor} - ${libro.categoria} (${libro.copiasDisponibles} disponibles)</option>
            `).join('');
        }

        function buscarLibros(query, exactMatch = false) {
            if (!catalogo.length || !query) return [];
            const lowerQuery = normalizarTexto(query);
            if (exactMatch) {
                return catalogo.filter(libro => normalizarTexto(libro.titulo) === lowerQuery);
            }
            return catalogo
                .filter(libro =>
                    normalizarTexto(libro.titulo).includes(lowerQuery) ||
                    normalizarTexto(libro.autor).includes(lowerQuery) ||
                    normalizarTexto(libro.categoria).includes(lowerQuery) ||
                    normalizarTexto(libro.signatura).includes(lowerQuery) ||
                    normalizarTexto(libro.isbn).includes(lowerQuery)
                )
                .sort((a, b) => b.copiasDisponibles - a.copiasDisponibles);
        }

        function mostrarResultadosBusqueda() {
            if (!catalogo.length) {
                showToast('Catálogo en Mantenimiento, discupe las molestias.', 'warning');
                return;
            }
            const query = document.getElementById('buscarInput').value.trim();
            if (!query) {
                showToast('Por favor, introduce un término de búsqueda.', 'warning');
                return;
            }
            searchQuery = query;
            searchResults = buscarLibros(query);
            currentPageSearch = 1;
            abrirModal();
            mostrarResultadosModal();
        }

        function buscarEnModal() {
            const query = document.getElementById('modalSearchInput').value.trim();
            if (!query) {
                showToast('Por favor, introduce un término de búsqueda.', 'warning');
                return;
            }
            searchQuery = query;
            searchResults = buscarLibros(query);
            currentPageSearch = 1;
            mostrarResultadosModal();
        }

        function abrirModal() {
            const modal = document.getElementById('searchModal');
            const modalSearchInput = document.getElementById('modalSearchInput');
            modalSearchInput.value = searchQuery;
            modal.style.display = 'block';
            modalSearchInput.focus();
            document.querySelector('.theme-controls').classList.add('active');
        }

        async function renderPortadas(container, idLibro) {
            const libro = catalogo.find(l => l.idRegistro === idLibro);
            if (!libro || !libro.portadas || libro.portadas.length === 0) {
                const defaultImg = document.createElement('img');
                defaultImg.src = DEFAULT_PORTADA;
                defaultImg.alt = 'Portada no disponible';
                defaultImg.className = 'default-placeholder';
                container.appendChild(defaultImg);
                container.classList.add('loaded');
                return;
            }

            const slider = document.createElement('div');
            slider.className = 'portada-slider';
            container.appendChild(slider);

            const loadImagePromises = libro.portadas.map(url => 
                new Promise(resolve => {
                    const img = new Image();
                    img.src = url;
                    img.alt = '';
                    img.className = 'portada-img';
                    img.crossOrigin = 'anonymous';
                    img.loading = 'lazy';
                    img.onload = () => resolve({ img, success: true });
                    img.onerror = () => resolve({ success: false });
                    setTimeout(() => resolve({ success: false }), 5000);
                })
            );

            const results = await Promise.all(loadImagePromises);
            const validImages = results.filter(r => r.success).map(r => r.img);

            if (validImages.length === 0) {
                slider.remove();
                const defaultImg = document.createElement('img');
                defaultImg.src = DEFAULT_PORTADA;
                defaultImg.alt = 'Portada no disponible';
                defaultImg.className = 'default-placeholder';
                container.appendChild(defaultImg);
                container.classList.add('loaded');
                return;
            }

            validImages.forEach((img, i) => {
                img.style.display = 'block';
                if (i === 0) img.classList.add('active');
                slider.appendChild(img);
            });

            if (validImages.length >= 1) {
                slider.classList.add('portada-slider-3d');
                const angle = 360 / validImages.length;
                validImages.forEach((img, i) => {
                    img.className = 'portada-img-3d';
                    if (i === 0) img.classList.add('active');
                    img.style.transform = `rotateY(${i * angle}deg) translateZ(80px)`;
                    slider.appendChild(img);
                });

                let current = 0;
                const interval = setInterval(() => {
                    current = (current + 1) % validImages.length;
                    slider.style.transform = `rotateY(${-current * angle}deg)`;
                }, 2500);

                const observer = new MutationObserver(() => {
                    if (getComputedStyle(document.getElementById('searchModal')).display === 'none') {
                        clearInterval(interval);
                        observer.disconnect();
                    }
                });
                observer.observe(document.getElementById('searchModal'), { attributes: true });
            }

            container.classList.add('loaded');
        }

        function mostrarResultadosModal() {
            const pageSize = 5;
            const totalPages = Math.ceil(searchResults.length / pageSize);
            const start = (currentPageSearch - 1) * pageSize;
            const end = start + pageSize;
            const paginatedResults = searchResults.slice(start, end);
            const isAdminLogged = localStorage.getItem('adminLogged') === 'true';

            const conteoDiv = document.getElementById('conteoResultadosModal');
            if (searchResults.length > 0) {
                conteoDiv.textContent = `Encontrados ${searchResults.length} resultados. El color del Tejuelo indica su estantería.`;
                conteoDiv.style.display = 'block';
            } else {
                conteoDiv.textContent = 'No se encontraron resultados.';
                conteoDiv.style.display = 'block';
            }

            const resultadosDiv = document.getElementById('resultadosModal');
            resultadosDiv.innerHTML = paginatedResults.map(libro => {
                const esFavorito = favoritos.includes(libro.idRegistro);
                return `
                <div class="libro-modal" role="region" aria-label="Resultado de búsqueda para ${libro.titulo}">
                    <div class="portada-section">
                        <div class="portada-container" data-libro-id="${libro.idRegistro}"></div>
                    </div>
                    <div class="info-section">
                        <p><strong>Título:</strong> ${libro.titulo}</p>
                        <p><strong>Autor:</strong> ${libro.autor}</p>
                        <p><strong>Categoría:</strong> ${libro.categoria}</p>
                        <p><strong>Tejuelo:</strong> <span class="tejuelo" data-categoria="${libro.categoria.toLowerCase()}">${libro.signatura}</span></p>
                        <p><strong>Ejemplares Disponibles:</strong> ${libro.copiasDisponibles}</p>
                        <button class="reserva-libro-btn" onclick="window.open('https://docs.google.com/forms/d/e/1FAIpQLSeTUAdMIEZz0lP2qflcZgfIP2zhsU4sYJoQZYoJcmvUZRAQnw/viewform', '_blank')"
                             aria-label="Reservar el libro ${libro.titulo}">Reservar Libro Book</button>
                        <button class="sinopsis-btn" onclick="mostrarSinopsis('${libro.idRegistro}', '${sanitizeHTML(libro.titulo)}', '${sanitizeHTML(libro.autor)}')"
                                aria-label="Generar sinopsis para ${libro.titulo}">Generar Sinopsis Note</button>
                        <button class="favorito-btn ${esFavorito ? 'active' : ''}" onclick="toggleFavorito('${libro.idRegistro}')" aria-label="${esFavorito ? 'Quitar' : 'Agregar'} a favoritos">Heart</button>
                        <button class="add-cover-btn" onclick="abrirLoginAdmin('${libro.idRegistro}')"
                            aria-label="Abrir panel de admin para subir portada para ${libro.titulo}">+</button>
                        ${isAdminLogged && libro.portadas.length > 0 ? `
                            <button class="delete-cover-btn" onclick="abrirEliminarPortada('${libro.idRegistro}')"
                                aria-label="Eliminar portada para ${libro.titulo}">−</button>
                        ` : ''}
                        <div id="sinopsis-${libro.idRegistro}" style="display: none; margin-top: 10px;"></div>
                    </div>
                </div>
            `;
            }).join('') || '<p>No se encontraron libros en esta página.</p>';

            const paginationDiv = document.getElementById('searchPagination');
            if (totalPages > 1) {
                let paginationHTML = `<button onclick="changePageSearch(${currentPageSearch - 1})" ${currentPageSearch === 1 ? 'disabled' : ''}>Anterior</button>`;
                for (let i = 1; i <= totalPages; i++) {
                    paginationHTML += `<button onclick="changePageSearch(${i})" ${i === currentPageSearch ? 'class="active"' : ''}>${i}</button>`;
                }
                paginationHTML += `<button onclick="changePageSearch(${currentPageSearch + 1})" ${currentPageSearch === totalPages ? 'disabled' : ''}>Siguiente</button>`;
                paginationDiv.innerHTML = paginationHTML;
                paginationDiv.style.display = 'block';
            } else {
                paginationDiv.style.display = 'none';
            }

            setTimeout(async () => {
                const containers = document.querySelectorAll('.portada-container');
                for (const container of containers) {
                    const idLibro = container.dataset.libroId;
                    await renderPortadas(container, idLibro);
                }
            }, 100);
        }

        function changePageSearch(newPage) {
            const totalPages = Math.ceil(searchResults.length / 5);
            if (newPage < 1 || newPage > totalPages) return;
            currentPageSearch = newPage;
            mostrarResultadosModal();
        }

        function toggleFavorito(idLibro) {
            const index = favoritos.indexOf(idLibro);
            if (index > -1) {
                favoritos.splice(index, 1);
                showToast('Libro removido de favoritos', 'warning');
            } else {
                favoritos.push(idLibro);
                showToast('Libro agregado a favoritos', 'success');
            }
            localStorage.setItem('libros_favoritos', JSON.stringify(favoritos));
            mostrarResultadosModal();
        }

        function abrirModalFavoritos() {
            const content = document.getElementById('favoritosContent');
            if (favoritos.length === 0) {
                content.innerHTML = '<p>No hay libros favoritos agregados.</p>';
            } else {
                const librosFavoritos = favoritos.map(id => catalogo.find(l => l.idRegistro === id)).filter(Boolean);
                content.innerHTML = librosFavoritos.map(libro => {
                    return `
                        <div class="libro-modal">
                            <div class="portada-section">
                                <div class="portada-container" data-libro-id="${libro.idRegistro}"></div>
                            </div>
                            <div class="info-section">
                                <p><strong>Título:</strong> ${libro.titulo}</p>
                                <p><strong>Autor:</strong> ${libro.autor}</p>
                                <p><strong>Categoría:</strong> ${libro.categoria}</p>
                                <p><strong>Tejuelo:</strong> <span class="tejuelo" data-categoria="${libro.categoria.toLowerCase()}">${libro.signatura}</span></p>
                                <p><strong>Ejemplares Disponibles:</strong> ${libro.copiasDisponibles}</p>
                                <button class="favorito-btn active" onclick="toggleFavorito('${libro.idRegistro}')">Heart</button>
                            </div>
                        </div>
                    `;
                }).join('');
                setTimeout(async () => {
                    const containers = content.querySelectorAll('.portada-container');
                    for (const container of containers) {
                        const idLibro = container.dataset.libroId;
                        await renderPortadas(container, idLibro);
                    }
                }, 100);
            }
            document.getElementById('favoritosModal').style.display = 'block';
        }

        async function initApp() {
            const MIN_SPLASH_DURATION = 2000;
            const startTime = Date.now();

            loadTheme();
            loadDaltonismMode();

            await cargarCatalogo();
            await cargarPortadasDesdeGitHub();  // <-- Ahora lee TODAS las portadas sin patrón
            await precargarPortadasAgresivo();

            const elapsedTime = Date.now() - startTime;
            const remainingTime = Math.max(0, MIN_SPLASH_DURATION - elapsedTime);
            if (remainingTime > 0) {
                await new Promise(resolve => setTimeout(resolve, remainingTime));
            }

            const splash = document.getElementById('splash');
            splash.classList.add('hidden');
            document.getElementById('app').style.display = 'block';
            document.getElementById('seccionDerecha').style.display = 'block';
            setTimeout(() => splash.remove(), 500);

            const isAdminLogged = localStorage.getItem('adminLogged') === 'true';
            const loginTime = localStorage.getItem('adminLoginTime');
            const LOGIN_DURATION = 24 * 60 * 60 * 1000;
            if (isAdminLogged && loginTime && (Date.now() - parseInt(loginTime) < LOGIN_DURATION)) {
                document.querySelector('.logout-btn').style.display = 'inline-block';
            } else {
                localStorage.removeItem('adminLogged');
                localStorage.removeItem('adminLoginTime');
                localStorage.removeItem('githubToken');
            }

            agregarMensaje('Libros, autores, sinopsis, resúmenes... Mi magia es poderosa, pregunta. Book');

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (document.getElementById('searchModal').style.display === 'block') cerrarModal();
                    if (document.getElementById('adminModal').style.display === 'block') cerrarModalAdmin();
                    if (document.getElementById('favoritosModal').style.display === 'block') cerrarModalFavoritos();
                }
            });
        }

        initApp();
    </script>
</body>
</html>